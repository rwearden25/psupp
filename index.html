<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#2563eb">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="P-Supp">
<meta name="description" content="Equipment diagnostics, service & reference for pressure washer equipment">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192x192.png">
<title>P-Supp Tool</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f5f7fa;--surface:#ffffff;--surface-2:#f0f2f5;--surface-3:#e8ebf0;--border:#d8dce5;--text:#1a1d24;--text-muted:#5f6b7a;--accent:#2563eb;--accent-dim:rgba(37,99,235,0.08);--success:#16a34a;--blue:#0ea5e9;--blue-dim:rgba(14,165,233,0.08);--radius:12px;--font-body:'DM Sans',sans-serif;--font-mono:'Space Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:-200px;left:50%;transform:translateX(-50%);width:800px;height:600px;background:radial-gradient(ellipse,rgba(37,99,235,0.04) 0%,transparent 70%);pointer-events:none;z-index:0}
.app{position:relative;z-index:1;display:flex;flex-direction:column;height:100vh;height:100dvh}
header{border-bottom:1px solid var(--border);padding:1rem 2rem;display:flex;align-items:center;gap:1rem;background:rgba(255,255,255,0.92);backdrop-filter:blur(20px);flex-shrink:0;z-index:100}
.logo{width:44px;height:44px;background:var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-weight:700;font-size:0.7rem;color:#fff;flex-shrink:0}
.header-text h1{font-size:1.1rem;font-weight:700;letter-spacing:-0.3px}
.header-text span{font-size:0.75rem;color:var(--text-muted);font-weight:300}
.header-stats{margin-left:auto;display:flex;gap:1.5rem}
.stat{text-align:center}
.stat-val{font-family:var(--font-mono);font-size:1rem;font-weight:700;color:var(--accent)}
.stat-label{font-size:0.62rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
@media(max-width:700px){.header-stats{display:none}}
.header-right{margin-left:auto;display:flex;align-items:center;gap:0.75rem}
.hamburger{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 8px;cursor:pointer;display:flex;flex-direction:column;gap:3px;position:relative}
.hamburger span{display:block;width:18px;height:2px;background:var(--text-muted);border-radius:1px;transition:0.2s}
.hamburger:hover span{background:var(--accent)}
.ham-menu{display:none;position:absolute;top:calc(100% + 8px);right:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:0.75rem;box-shadow:0 8px 24px rgba(0,0,0,0.08);z-index:200;min-width:200px}
.ham-menu.open{display:block}
.ham-link{display:flex;align-items:center;gap:0.5rem;width:100%;border:none;background:transparent;color:var(--text);padding:0.5rem 0.6rem;cursor:pointer;font-size:0.82rem;font-family:var(--font-body);border-radius:6px;transition:all 0.15s;text-align:left}
.ham-link:hover{background:var(--accent-dim);color:var(--accent)}
.ref-table{width:100%;border-collapse:collapse;font-size:0.8rem;font-family:var(--font-body)}
.ref-table th{background:var(--surface-2);font-weight:700;font-size:0.72rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);padding:0.5rem 0.6rem;text-align:left;border-bottom:2px solid var(--border);white-space:nowrap}
.ref-table td{padding:0.45rem 0.6rem;border-bottom:1px solid var(--border);color:var(--text)}
.ref-table tr:hover td{background:var(--accent-dim)}
.ref-table .nz-label{font-weight:600;background:var(--surface-2)}
.logout-btn{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;font-size:0.75rem;font-family:var(--font-body);color:var(--text-muted);cursor:pointer;transition:0.2s;white-space:nowrap}
.logout-btn:hover{border-color:#ef4444;color:#ef4444;background:rgba(239,68,68,0.06)}
.upload-btn{background:none;border:1px solid var(--border);border-radius:10px;padding:6px 12px;cursor:pointer;color:var(--text-muted);font-size:0.82rem;font-family:var(--font-body);transition:0.2s;display:flex;align-items:center;gap:0.3rem;white-space:nowrap}
.upload-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.img-preview-bar{display:flex;align-items:center;gap:0.5rem;padding:0.4rem 1rem;background:var(--surface-2);border-bottom:1px solid var(--border);font-size:0.78rem;color:var(--text-muted)}
.img-preview-bar img{width:40px;height:40px;object-fit:cover;border-radius:6px;border:1px solid var(--border)}
.img-preview-bar .remove-img{background:none;border:none;color:#ef4444;cursor:pointer;font-size:1rem;padding:0 4px}
.img-in-chat{max-width:240px;border-radius:8px;border:1px solid var(--border);margin-bottom:0.5rem}
.typing-cursor::after{content:'â–Š';animation:blink 0.7s infinite;color:var(--accent);font-weight:300}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.input-bar{padding:0.75rem 2rem;border-top:1px solid var(--border);background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);position:fixed;bottom:0;left:0;right:0;z-index:99;transition:transform 0.15s ease-out;will-change:transform}
.input-wrap{max-width:820px;margin:0 auto;display:flex;gap:0.5rem}
.input-wrap input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:16px;outline:none;transition:border-color 0.2s}
.input-wrap input:focus{border-color:var(--accent)}
.input-wrap input::placeholder{color:var(--text-muted)}
.send-btn{border-radius:12px;border:none;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.35rem;font-size:0.85rem;font-weight:600;font-family:var(--font-body);transition:all 0.15s;flex-shrink:0;padding:0 1rem;height:44px}
.send-btn:hover{filter:brightness(1.15);transform:scale(1.04)}
.layout{display:grid;grid-template-columns:260px 1fr;flex:1;overflow:hidden}
@media(max-width:900px){.layout{grid-template-columns:1fr;order:2}.sidebar{display:none}.input-bar{position:relative;bottom:auto;left:auto;right:auto;order:3;flex-shrink:0;will-change:auto}.main{padding-bottom:1rem}}
@media(max-width:600px){
  .upload-btn span.btn-label,.send-btn span.btn-label{display:none}
  .send-btn{width:44px;padding:0}
  .upload-btn{padding:6px 10px}
  .nav-btn{font-size:0.78rem;padding:0.45rem 0.85rem}
  .input-bar{padding:0.6rem 1rem}
  .quick-actions{grid-template-columns:1fr 1fr}
}
.sidebar{background:var(--surface);border-right:1px solid var(--border);overflow-y:auto}
.sb-section{border-bottom:1px solid var(--border)}
.sb-header{display:flex;align-items:center;gap:0.6rem;padding:0.65rem 1rem;cursor:pointer;user-select:none;transition:background 0.15s}
.sb-header:hover{background:var(--surface-2)}
.sb-chevron{font-size:0.6rem;color:var(--text-muted);transition:transform 0.25s;width:12px;text-align:center}
.sb-section.collapsed .sb-chevron{transform:rotate(-90deg)}
.sb-brand{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1px}
.sb-count{font-size:0.6rem;color:var(--text-muted);font-family:var(--font-mono);margin-left:auto}
.sb-body{overflow:hidden;transition:max-height 0.3s ease}
.sb-section.collapsed .sb-body{max-height:0 !important}
.sb-group-label{padding:0.25rem 1rem 0.15rem 2.2rem;font-size:0.62rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-top:0.3rem}
.topic-btn{display:flex;align-items:center;gap:0.55rem;width:100%;border:none;background:transparent;color:var(--text-muted);padding:0.45rem 1rem 0.45rem 2.2rem;cursor:pointer;font-size:0.8rem;font-family:var(--font-body);transition:all 0.15s;text-align:left}
.topic-btn:hover{background:var(--surface-2);color:var(--text)}
.topic-btn.active{background:var(--accent-dim);color:var(--accent);font-weight:600;border-right:3px solid var(--accent)}
.topic-icon{font-size:0.85rem;width:1.1rem;text-align:center}
.home-btn{display:flex;align-items:center;gap:0.6rem;width:100%;border:none;background:transparent;color:var(--text-muted);padding:0.65rem 1rem;cursor:pointer;font-size:0.85rem;font-family:var(--font-body);transition:all 0.15s;border-bottom:1px solid var(--border)}
.home-btn:hover{background:var(--surface-2);color:var(--text)}
.home-btn.active{background:var(--accent-dim);color:var(--accent);font-weight:600}
.main{padding:2rem 2rem 100px 2rem;overflow-y:auto}
.welcome{max-width:640px;margin:0 auto;animation:fadeUp 0.3s ease;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center}
.welcome-icon{font-size:2.5rem;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.3rem;justify-content:center}
@keyframes pippie-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
@keyframes pippie-blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(0.1)}}
@keyframes pippie-steam{0%{opacity:0.8;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-12px) scale(1.5)}}
.pippie{animation:pippie-bounce 2s ease-in-out infinite}
.pb{animation:pippie-blink 3s infinite;transform-origin:center}
.ps1{animation:pippie-steam 2s ease-out infinite}
.ps2{animation:pippie-steam 2s ease-out 0.7s infinite}
.welcome h2{font-size:1.5rem;margin-bottom:0.5rem;letter-spacing:-0.5px}
.welcome>p{color:var(--text-muted);font-size:0.88rem;margin-bottom:2rem;line-height:1.6;max-width:520px}
.home-search{width:100%;max-width:620px;position:relative;margin-bottom:1.5rem}
.home-search-box{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:0.25rem;display:flex;align-items:center;box-shadow:0 2px 16px rgba(0,0,0,0.04);transition:border-color 0.2s,box-shadow 0.2s}
.home-search-box:focus-within{border-color:var(--accent);box-shadow:0 2px 24px rgba(37,99,235,0.1)}
.home-search-box input{flex:1;background:transparent;border:none;padding:0.85rem 1rem;color:var(--text);font-family:var(--font-body);font-size:0.95rem;outline:none;min-width:0}
.home-search-box input::placeholder{color:var(--text-muted)}
.home-search-actions{display:flex;align-items:center;gap:0.25rem;padding-right:0.35rem}
.home-search-actions button{border:none;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s;font-size:0.9rem;flex-shrink:0}
.home-search-actions .upload-home{background:transparent;color:var(--text-muted)}
.home-search-actions .upload-home:hover{background:var(--surface-2);color:var(--accent)}
.home-search-actions .search-send{background:var(--accent);color:#fff}
.home-search-actions .search-send:hover{filter:brightness(1.15);transform:scale(1.06)}
.home-hint{font-size:0.76rem;color:var(--text-muted);margin-top:0.5rem}
.mobile-quick{display:none;width:100%;max-width:560px}
@media(max-width:900px){.mobile-quick{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-top:1rem}}
.sb-quick{padding:0.5rem 0;border-bottom:1px solid var(--border)}
.sb-quick-btn{display:flex;align-items:center;gap:0.55rem;width:100%;border:none;background:transparent;color:var(--text);padding:0.5rem 1rem;cursor:pointer;font-size:0.82rem;font-family:var(--font-body);transition:all 0.15s;text-align:left;font-weight:500}
.sb-quick-btn:hover{background:var(--accent-dim);color:var(--accent)}
.sb-quick-btn .qicon{font-size:0.95rem;width:1.2rem;text-align:center}
.input-bar.hidden{display:none}
.quick-actions{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.7rem}
.quick-btn{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:0.8rem 1rem;cursor:pointer;display:flex;align-items:center;gap:0.6rem;color:var(--text);font-size:0.82rem;font-family:var(--font-body);transition:all 0.15s;text-align:left}
.quick-btn:hover{border-color:var(--accent);background:var(--accent-dim)}
.qicon{font-size:1rem}
.section-page{max-width:860px;margin:0 auto;animation:fadeUp 0.3s ease}
.back-btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:0.5rem 1rem;border-radius:10px;cursor:pointer;font-size:0.82rem;font-family:var(--font-body);font-weight:500;margin-bottom:1.25rem;transition:all 0.15s;display:inline-flex;align-items:center;gap:0.3rem}
.back-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.chat-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;gap:0.5rem}
.nav-btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:0.55rem 1.1rem;border-radius:10px;cursor:pointer;font-size:0.84rem;font-family:var(--font-body);font-weight:500;transition:all 0.15s;display:inline-flex;align-items:center;gap:0.4rem}
.nav-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.nav-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.nav-btn.primary:hover{background:#1d4ed8}
.page-header{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem}
.page-header-icon{font-size:2rem}
.page-header h2{font-size:1.3rem;letter-spacing:-0.4px}
.page-header p{color:var(--text-muted);font-size:0.82rem}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem}
.card h4{font-size:0.88rem;margin-bottom:0.7rem;color:var(--accent);font-weight:600}
.cause-item{padding:0.55rem 0;border-bottom:1px solid var(--border);font-size:0.83rem;line-height:1.6}
.cause-item:last-child{border-bottom:none}
.cause-item strong{display:block;margin-bottom:0.1rem}
.cause-item span{color:var(--success)}
.info-block{background:var(--surface-2);border-radius:10px;padding:0.8rem 1rem;margin:0.5rem 0;font-size:0.83rem;line-height:1.6}
.info-block p{margin-bottom:0.35rem}
.info-block p:last-child{margin-bottom:0}
.step-list{counter-reset:step;padding:0;list-style:none}
.step-item{display:flex;gap:0.7rem;padding:0.6rem 0;border-bottom:1px solid var(--border);font-size:0.85rem;line-height:1.55}
.step-item:last-child{border-bottom:none}
.step-num{width:26px;height:26px;border-radius:8px;background:var(--accent-dim);color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem;flex-shrink:0;font-family:var(--font-mono)}
.oil-result{background:var(--accent-dim);border:1px solid rgba(37,99,235,0.15);padding:0.8rem 1rem;border-radius:10px;margin:0.5rem 0;font-family:var(--font-mono);font-size:0.8rem}
.oil-result .model{color:var(--accent);font-weight:700}
.oil-badge{display:inline-block;padding:0.15rem 0.5rem;border-radius:6px;font-family:var(--font-mono);font-size:0.7rem;font-weight:700}
.oil-badge.s100{background:rgba(59,130,246,0.15);color:#60a5fa}
.oil-badge.s220{background:rgba(34,197,94,0.15);color:#4ade80}
.oil-badge.s8090{background:rgba(124,58,237,0.12);color:#7c3aed}
.data-table{width:100%;border-collapse:collapse;font-size:0.78rem;margin-top:0.5rem}
.data-table th{text-align:left;padding:0.5rem 0.6rem;background:var(--surface-3);color:var(--accent);font-size:0.68rem;text-transform:uppercase;letter-spacing:0.8px;border-bottom:2px solid var(--border);position:sticky;top:0}
.data-table td{padding:0.4rem 0.6rem;border-bottom:1px solid var(--border);color:var(--text-muted);font-family:var(--font-mono);font-size:0.76rem}
.data-table tr:hover td{color:var(--text);background:rgba(37,99,235,0.03)}
.data-table .model-cell{color:var(--accent);font-weight:700}
.tag{display:inline-block;padding:0.13rem 0.45rem;border-radius:5px;font-size:0.68rem;font-family:var(--font-mono);background:var(--surface-3);color:var(--text-muted);margin:0.1rem}
.msg{margin-bottom:1.5rem;animation:fadeUp 0.3s ease}
.msg-user{display:flex;justify-content:flex-end}
.msg-user .bubble{background:var(--accent);color:#fff;padding:0.65rem 1rem;border-radius:16px 16px 4px 16px;max-width:75%;font-weight:500;font-size:0.88rem}
.msg-bot{display:flex;gap:0.7rem;align-items:flex-start}
.bot-avatar{width:30px;height:30px;background:var(--surface-3);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;flex-shrink:0;margin-top:2px}
.msg-bot .bubble{background:var(--surface);border:1px solid var(--border);padding:0.9rem 1.15rem;border-radius:4px 16px 16px 16px;max-width:85%;font-size:0.88rem;line-height:1.65}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â”€â”€â”€ SAVED DIAGNOSTICS â”€â”€â”€ */
.save-btn{display:inline-flex;align-items:center;gap:0.35rem;background:none;border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.8rem;cursor:pointer;font-size:0.78rem;color:var(--text-muted);font-family:var(--font-body);margin-top:0.6rem;transition:all 0.15s}
.feedback-row{display:flex;align-items:center;gap:0.4rem;margin-top:0.3rem;margin-left:2.4rem}
.feedback-label{font-size:0.72rem;color:var(--text-muted);font-family:var(--font-body)}
.fb-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:0.25rem 0.5rem;cursor:pointer;font-size:0.85rem;transition:all 0.15s;line-height:1}
.fb-btn:hover{background:var(--accent-dim);border-color:var(--accent)}
.fb-btn.fb-active{background:var(--accent-dim);border-color:var(--accent)}
.correction-box{margin-top:0.4rem;margin-left:2.4rem;animation:fadeUp 0.2s ease}
.correction-box textarea{width:100%;max-width:400px;min-height:60px;border:1px solid var(--border);border-radius:8px;padding:0.5rem 0.7rem;font-size:0.8rem;font-family:var(--font-body);resize:vertical;outline:none;transition:border-color 0.2s}
.correction-box textarea:focus{border-color:var(--accent)}
.correction-box button{margin-top:0.3rem;background:var(--accent);color:#fff;border:none;border-radius:6px;padding:0.35rem 0.75rem;font-size:0.75rem;font-family:var(--font-body);cursor:pointer}
.correction-box button:hover{filter:brightness(1.1)}
.correction-box .correction-sent{font-size:0.75rem;color:var(--success);font-family:var(--font-body)}
.save-btn:hover{border-color:#16a34a;color:#16a34a;background:rgba(22,163,74,0.06)}
.save-btn.saved{border-color:#16a34a;color:#16a34a;cursor:default}
.save-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:none;align-items:center;justify-content:center;padding:1rem}
.save-modal-overlay.open{display:flex}
.save-modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;padding:1.5rem}
.save-modal h3{font-size:1.05rem;margin-bottom:1rem}
.save-field{margin-bottom:0.75rem}
.save-field label{display:block;font-size:0.72rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:0.25rem}
.save-field input,.save-field textarea,.save-field select{width:100%;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:0.55rem 0.75rem;color:var(--text);font-family:var(--font-body);font-size:0.85rem;outline:none}
.save-field input:focus,.save-field textarea:focus,.save-field select:focus{border-color:var(--accent)}
.save-field textarea{resize:vertical;min-height:70px}
.save-row{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
.save-actions{display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)}
.save-actions button{padding:0.5rem 1.2rem;border-radius:8px;border:1px solid var(--border);font-size:0.85rem;font-family:var(--font-body);cursor:pointer}
.save-actions .cancel-btn{background:transparent;color:var(--text-muted)}
.save-actions .confirm-btn{background:#16a34a;color:#fff;border-color:#16a34a;font-weight:600}
.save-actions .confirm-btn:hover{background:#15803d}
.diag-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1rem 1.25rem;cursor:pointer;transition:all 0.15s}
.diag-card:hover{border-color:var(--accent);background:var(--surface-2)}
.diag-card-header{display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem}
.diag-card h4{font-size:0.9rem;margin-bottom:0.25rem}
.diag-card .diag-meta{font-size:0.72rem;color:var(--text-muted);font-family:var(--font-mono)}
.diag-card .diag-category{display:inline-block;padding:0.1rem 0.5rem;border-radius:10px;font-size:0.68rem;font-weight:600;background:var(--accent-dim);color:var(--accent)}
.diag-card .diag-machine{font-size:0.78rem;color:var(--text-muted);margin-top:0.35rem}
.diag-card-actions{display:flex;gap:0.4rem;flex-shrink:0}
.diag-card-actions button{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.72rem;color:var(--text-muted);transition:0.15s}
.diag-card-actions .dl-btn:hover{border-color:var(--accent);color:var(--accent)}
.diag-card-actions .del-btn:hover{border-color:#ef4444;color:#ef4444}
.diag-list{display:flex;flex-direction:column;gap:0.75rem}
.diag-empty{text-align:center;padding:3rem 1rem;color:var(--text-muted)}
.diag-empty-icon{font-size:2.5rem;margin-bottom:0.75rem}
.diag-detail-header{display:flex;gap:1rem;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap}
.diag-detail-actions{display:flex;gap:0.5rem;margin-left:auto}
.sev-badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:0.7rem;font-weight:700;color:#fff}
.sev-critical{background:#dc2626}.sev-high{background:#ea580c}.sev-medium{background:#ca8a04}.sev-low{background:#16a34a}
@media(max-width:500px){.save-row{grid-template-columns:1fr}.save-modal{padding:1rem}}
#loginGate{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:99999;font-family:var(--font-body)}
#loginGate.hidden{display:none}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,0.08);padding:44px;width:380px;text-align:center}
.login-box::before{content:'';position:absolute;top:-150px;left:50%;transform:translateX(-50%);width:400px;height:300px;background:radial-gradient(ellipse,rgba(37,99,235,0.06) 0%,transparent 70%);pointer-events:none}
.login-logo-box{width:64px;height:64px;background:var(--accent);border-radius:14px;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-weight:700;font-size:0.9rem;color:#fff;margin:0 auto 20px}
.login-box h2{font-size:1.3rem;font-weight:700;color:var(--text);margin-bottom:6px;letter-spacing:-0.3px}
.login-box p{color:var(--text-muted);font-size:0.82rem;margin-bottom:28px}
.login-box input{width:100%;padding:12px 16px;background:var(--surface-2);border:1px solid var(--border);color:var(--text);border-radius:10px;font-size:16px;font-family:var(--font-body);outline:none;transition:border-color 0.2s;box-sizing:border-box;margin-bottom:14px}
.login-box input:focus{border-color:var(--accent)}
.login-box input::placeholder{color:var(--text-muted)}
.login-box button{width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:0.9rem;font-weight:700;font-family:var(--font-body);cursor:pointer;transition:all 0.15s}
.login-box button:hover{filter:brightness(1.15);transform:scale(1.02)}
.login-error{color:#f87171;font-size:0.78rem;margin-top:10px;display:none}
#appContent{display:none}
#appContent.visible{display:flex;flex-direction:column;height:100vh;height:100dvh;overflow:hidden}

/* â•â•â• MOBILE ENHANCEMENTS â•â•â• */

/* iPhone notch / Dynamic Island safe areas */
@supports(padding:env(safe-area-inset-top)){
  header{padding-top:max(1rem,env(safe-area-inset-top));padding-left:max(2rem,env(safe-area-inset-left));padding-right:max(2rem,env(safe-area-inset-right))}
  .input-bar{padding-left:max(0.75rem,env(safe-area-inset-left));padding-right:max(0.75rem,env(safe-area-inset-right));padding-bottom:max(0.75rem,env(safe-area-inset-bottom))}
}

/* iOS momentum scrolling */
.main,.sidebar{-webkit-overflow-scrolling:touch;overscroll-behavior:contain}

/* Touch feedback on interactive elements */
.quick-btn:active{transform:scale(0.97);opacity:0.85}
.topic-btn:active{background:var(--surface-3);transform:scale(0.98)}
.nav-btn:active{transform:scale(0.97)}
.send-btn:active{transform:scale(0.94)}
.back-btn:active{transform:scale(0.97)}
.upload-btn:active{transform:scale(0.97)}

/* Prevent tap highlight flash on iOS */
.quick-btn,.topic-btn,.nav-btn,.send-btn,.back-btn,.upload-btn,.home-btn,.hamburger,.logout-btn{
  -webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}

/* Touch target minimums (44px per Apple/Google guidelines) */
.topic-btn{min-height:44px}
.home-btn{min-height:44px}
.quick-btn{min-height:44px}

/* Small phones (â‰¤400px, iPhone SE) */
@media(max-width:400px){
  header{padding:0.6rem 0.75rem;gap:0.5rem}
  .logo{width:36px;height:36px;font-size:0.6rem;border-radius:8px}
  .header-text h1{font-size:0.9rem}
  .header-text span{font-size:0.65rem}
  .input-bar{padding:0.5rem 0.6rem}
  .quick-actions{grid-template-columns:1fr}
  .mobile-quick{grid-template-columns:1fr}
  .welcome h2{font-size:1.2rem}
  .welcome>p{font-size:0.82rem}
  .home-search{flex-wrap:wrap}
  .home-search input{min-width:0}
  .msg-user .bubble{max-width:82%;border-radius:18px 18px 4px 18px;padding:0.55rem 0.9rem;font-size:0.9rem}
  .msg{margin-bottom:0.4rem}
  .msg-bot{gap:0}
  .msg-bot .bot-avatar{display:none}
  .msg-bot .bubble{max-width:88%;border-radius:18px 18px 18px 4px;padding:0.55rem 0.9rem;font-size:0.9rem;background:#e9e9eb;border:none;color:#000}
  body.ios .msg-user .bubble{background:#007AFF}
  body.android .msg-user .bubble{background:#34C759}
  .correction-box{margin-left:0}
  .feedback-row{margin-left:0}
  .login-box{width:calc(100vw - 2rem);padding:28px 24px}
}

/* Landscape phones */
@media(max-height:500px) and (orientation:landscape){
  header{padding:0.4rem 1rem}
  .input-bar{padding:0.4rem 1rem}
  .logo{width:32px;height:32px}
}
</style>
</head>
<body>
<!-- Login Gate -->
<div id="loginGate">
  <div class="login-box">
    <div class="login-logo-box">P-S</div>
    <h2>P-Supp Tool</h2>
    <p>Internal Access Only</p>
    <input type="password" id="loginPass" placeholder="Enter team password" autocomplete="off" />
    <button onclick="tryLogin()">Sign In</button>
    <div class="login-error" id="loginError">Incorrect password. Try again.</div>
  </div>
</div>
<script>
const TEAM_PASSWORD = "psupp2025"; // â† CHANGE THIS
function tryLogin(){const i=document.getElementById('loginPass'),e=document.getElementById('loginError');if(i.value===TEAM_PASSWORD){sessionStorage.setItem('authenticated','true');unlockApp();}else{e.style.display='block';i.value='';i.focus();}}
function unlockApp(){document.getElementById('loginGate').classList.add('hidden');document.getElementById('appContent').classList.add('visible');}
document.getElementById('loginPass').addEventListener('keydown',function(e){if(e.key==='Enter')tryLogin();});
</script>

<div id="appContent">
<div class="app">
  <header>
    <div class="logo" onclick="exitChat?exitChat():showHome()" style="cursor:pointer" title="Home">P-S</div>
    <div class="header-text" onclick="exitChat?exitChat():showHome()" style="cursor:pointer"><h1>P-Supp Tool</h1><span>Diagnostics, Service &amp; Reference</span></div>
    <div class="header-right">
      <div style="position:relative">
        <button class="hamburger" onclick="document.getElementById('hamMenu').classList.toggle('open')" title="Reference Charts">
          <span></span><span></span><span></span>
        </button>
        <div class="ham-menu" id="hamMenu">
          <div style="display:flex;flex-direction:column;gap:0.5rem;min-width:180px">
            <div style="font-weight:700;font-size:0.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding-bottom:0.25rem;border-bottom:1px solid var(--border)">Reference Charts</div>
            <button class="ham-link" onclick="showNozzleChart();document.getElementById('hamMenu').classList.remove('open')">ğŸ¯ Nozzle Size Chart</button>
            <button class="ham-link" onclick="showInjectorChart();document.getElementById('hamMenu').classList.remove('open')">ğŸ’‰ Injector Sizing Chart</button>
          </div>
        </div>
      </div>
      <button class="logout-btn" onclick="sessionStorage.removeItem('authenticated');location.reload();">Logout</button>
    </div>
  </header>
  <div class="input-bar hidden">
    <div id="imgPreviewBar" class="img-preview-bar" style="display:none"><img id="imgThumb"/><span id="imgName"></span><button class="remove-img" onclick="clearImage()" title="Remove">âœ•</button></div>
    <div class="input-wrap">
    <input type="file" id="imageUpload" accept="image/*" style="display:none" onchange="handleImageSelect(event)"/>
    <button class="upload-btn" onclick="document.getElementById('imageUpload').click()" title="Upload photo">ğŸ“· <span class="btn-label">Photo</span></button>
    <input type="text" id="userInput" placeholder="Search models, troubleshoot issues, look up specsâ€¦" autocomplete="off"/>
    <button class="send-btn" onclick="handleSend()" title="Send"><span class="btn-label">Send</span> â¤</button>
  </div></div>
  <div class="layout">
    <nav class="sidebar" id="sidebar"></nav>
    <div class="main"><div class="content-area" id="contentArea"></div></div>
  </div>
</div>
<script src="knowledge-base.js"></script>
<script>
const C=document.getElementById('contentArea'),I=document.getElementById('userInput'),SB=document.getElementById('sidebar');
const MAIN=C.parentElement; // .main is the scrollable container
const SESSION_ID = 'sess_' + Date.now().toString(36) + Math.random().toString(36).substring(2,8);
const isMobile = ('ontouchstart' in window || navigator.maxTouchPoints > 0);
function safeFocus(el){ if(!isMobile && el) el.focus(); }
if(isMobile){const ua=navigator.userAgent;if(/iPad|iPhone|iPod/.test(ua))document.body.classList.add('ios');else if(/Android/.test(ua))document.body.classList.add('android');}
function scrollToMsg(el){if(el){const container=el.closest('.main')||MAIN;const top=el.offsetTop-container.offsetTop;container.scrollTo({top:top,behavior:'smooth'});}}
function scrollBottom(){MAIN.scrollTop=MAIN.scrollHeight;}
if(sessionStorage.getItem('authenticated')==='true')unlockApp();
window.addEventListener('popstate',function(e){if(inChat){exitChat();}});

/* â•â•â• IMAGE UPLOAD â•â•â• */
let pendingImage=null;
function handleImageSelect(e){
  const file=e.target.files[0];if(!file)return;
  if(file.size>20*1024*1024){alert('Image too large. Max 20MB.');return;}
  const reader=new FileReader();
  reader.onload=function(ev){
    pendingImage={data:ev.target.result.split(',')[1], mediaType:file.type, name:file.name};
    document.getElementById('imgThumb').src=ev.target.result;
    document.getElementById('imgName').textContent=file.name;
    document.getElementById('imgPreviewBar').style.display='flex';
    I.placeholder='Describe the issue or ask about this equipment...';
    safeFocus(I);
  };
  reader.readAsDataURL(file);
}
function clearImage(){
  pendingImage=null;
  document.getElementById('imgPreviewBar').style.display='none';
  document.getElementById('imageUpload').value='';
  I.placeholder='Search models, troubleshoot issues, look up specsâ€¦';
}
const esc=t=>{const d=document.createElement('div');d.textContent=t;return d.innerHTML};
const norm=s=>s.toLowerCase().replace(/[^a-z0-9 ]/g,' ').replace(/\s+/g,' ').trim();
let _rcId=0;
const renderCauses=(c,limit)=>{
  const lim=typeof limit==='number'?limit:c.length;
  const show=c.slice(0,lim);
  const rest=c.slice(lim);
  let html=show.map(x=>`<div class="cause-item"><strong>âš  ${x.cause}</strong><span>âœ“ ${x.remedy}</span></div>`).join('');
  if(rest.length>0){
    _rcId++;
    html+=`<button class="show-more-btn" onclick="this.style.display='none';document.getElementById('rc${_rcId}').style.display='block'" style="background:none;border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.8rem;cursor:pointer;font-size:0.78rem;color:var(--accent);font-family:var(--font-body);margin-top:0.5rem">Show ${rest.length} more â–¾</button>`;
    html+=`<div id="rc${_rcId}" style="display:none">${rest.map(x=>`<div class="cause-item"><strong>âš  ${x.cause}</strong><span>âœ“ ${x.remedy}</span></div>`).join('')}</div>`;
  }
  return html;
};
const renderSteps=s=>`<ol class="step-list">${s.map((x,i)=>`<li class="step-item"><div class="step-num">${i+1}</div><div>${x}</div></li>`).join('')}</ol>`;

function buildSidebar(){
  if(!SB) return;
  let h=`<button class="home-btn active" data-topic="home" onclick="nav('home')"><span class="topic-icon">ğŸ </span> Home</button>`;
  h+=`<div class="sb-section collapsed" id="sec-charts"><div class="sb-header" onclick="toggleSection('sec-charts')"><span class="sb-chevron">â–¼</span><span class="sb-brand">Reference Charts</span></div><div class="sb-body"><div class="sb-quick">`;
  h+=`<button class="sb-quick-btn" onclick="showNozzleChart()"><span class="qicon">ğŸ¯</span>Nozzle Size Chart</button>`;
  h+=`<button class="sb-quick-btn" onclick="showInjectorChart()"><span class="qicon">ğŸ’‰</span>Injector Sizing Chart</button>`;
  h+=`</div></div></div>`;
  h+=`<div class="sb-section-label" style="padding:0.6rem 1rem 0.3rem;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted)">Diagnostics</div>`;
  h+=`<div class="sb-quick">`;
  [['pressure','ğŸ“‰','Low Pressure'],['electrical','âš¡','Electrical'],['burner','ğŸ”¥','Burner'],['service','âš™ï¸','Service & Repair']].forEach(([t,ic,lb])=>h+=`<button class="sb-quick-btn" onclick="startTopic('${t}')"><span class="qicon">${ic}</span>${lb}</button>`);
  h+=`</div>`;
  h+=`<button class="home-btn" data-topic="saved-diags" onclick="showSavedDiags()"><span class="topic-icon">ğŸ“‹</span> My Diagnostics</button>`;
  SB.innerHTML=h;
}

function toggleSection(id){const el=document.getElementById(id);el.classList.toggle('collapsed');if(!el.classList.contains('collapsed')){const body=el.querySelector('.sb-body');body.style.maxHeight=body.scrollHeight+'px';}}
function setActive(t){document.querySelectorAll('.topic-btn,.home-btn').forEach(b=>b.classList.remove('active'));const btn=document.querySelector(`[data-topic="${t}"]`);if(btn)btn.classList.add('active');}
function findOil(q){q=norm(q);const r=[];for(const[,s]of Object.entries(KB.gp.oilRecommendations)){for(const p of s.pumps){const pn=norm(p);if(q.includes(pn)||pn.includes(q.replace(/\s/g,'')))r.push({model:p,oil:s.label,weight:s.weight,badge:s.badge});}}return[...new Map(r.map(x=>[x.model,x])).values()];}

/* â•â•â• PAGES â•â•â• */

/* â”€â”€â”€ NOZZLE SIZE CHART â”€â”€â”€ */
function showNozzleChart(){
  setActive('home');inChat=false;document.querySelector('.input-bar').classList.add('hidden');
  // Nozzle # = GPM capacity at 4000 PSI. At other PSI: GPM = Nozzle# Ã— âˆš(PSI/4000)
  const pressures = [1000, 1500, 2000, 2500, 3000, 3500, 4000];
  const nozzles = [2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 7, 8, 10, 12, 15];
  const colors = {0:'Red',15:'Yellow',25:'Green',40:'White',65:'Black'};

  let rows = nozzles.map(n => {
    let cells = pressures.map(p => {
      const gpm = (n * Math.sqrt(p / 4000)).toFixed(1);
      return `<td>${gpm}</td>`;
    }).join('');
    return `<tr><td class="nz-label"><strong>#${n}</strong></td>${cells}</tr>`;
  }).join('');

  C.innerHTML = `<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button>
    <div class="page-header"><div class="page-header-icon">ğŸ¯</div><div><h2>Nozzle Size Chart</h2><p>GPM output by nozzle number and operating PSI</p></div></div>

    <div class="card" style="overflow-x:auto">
      <h4>Nozzle # â†’ GPM at Operating Pressure</h4>
      <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.75rem">Nozzle number = GPM capacity at 4,000 PSI. Spray angle does NOT affect flow rate.</p>
      <table class="ref-table">
        <thead><tr><th>Nozzle #</th>${pressures.map(p => `<th>${p.toLocaleString()} PSI</th>`).join('')}</tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>

    <div class="card">
      <h4>Spray Angle Color Codes</h4>
      <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.75rem">Standard color coding (may vary by manufacturer)</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:0.5rem">
        ${Object.entries(colors).map(([deg,color]) => `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem;background:var(--surface-2);border-radius:8px;font-size:0.82rem"><span style="width:24px;height:24px;border-radius:50%;background:${color.toLowerCase()};border:2px solid var(--border);flex-shrink:0"></span><strong>${deg}Â°</strong> ${color}</div>`).join('')}
      </div>
    </div>

    <div class="card">
      <h4>Tip Code Format</h4>
      <p style="font-size:0.85rem;line-height:1.6">Tip code = <strong>AABB</strong> where AA = spray angle, BB = nozzle size Ã— 10.<br>
      Example: <strong>2540</strong> = 25Â° angle, #4.0 nozzle (4.0 GPM at 4,000 PSI)</p>
      <p style="font-size:0.85rem;line-height:1.6;margin-top:0.5rem">âš ï¸ A nozzle that is <strong>too small</strong> causes over-pressurization.<br>
      âš ï¸ A <strong>worn</strong> nozzle reduces system pressure â€” check nozzles regularly for wear.</p>
    </div>

    <div style="text-align:center;padding:1rem">
      <button class="quick-btn" onclick="startTopic('nozzle')" style="border-color:rgba(37,99,235,0.3);background:rgba(37,99,235,0.04)"><span class="qicon">ğŸ¤–</span> Ask AI to calculate a specific nozzle</button>
    </div>
  </div>`;
  MAIN.scrollTop=0;
}

/* â”€â”€â”€ INJECTOR SIZING CHART â”€â”€â”€ */
function showInjectorChart(){
  setActive('home');inChat=false;document.querySelector('.input-bar').classList.add('hidden');

  const dsData = [
    {gpm:'2.0', ratio:'10:1', draw_oz:'2.6', draw_gph:'1.2', model:'Standard DS', notes:'Short hose runs'},
    {gpm:'2.5', ratio:'10:1', draw_oz:'3.2', draw_gph:'1.5', model:'Standard DS', notes:'Short hose runs'},
    {gpm:'3.0', ratio:'10:1', draw_oz:'3.8', draw_gph:'1.8', model:'Standard DS', notes:'Up to 100 ft hose'},
    {gpm:'3.5', ratio:'10:1', draw_oz:'4.5', draw_gph:'2.1', model:'Standard DS', notes:'Up to 100 ft hose'},
    {gpm:'4.0', ratio:'10:1', draw_oz:'5.1', draw_gph:'2.4', model:'Standard DS', notes:'Up to 150 ft hose'},
    {gpm:'5.0', ratio:'10:1', draw_oz:'6.4', draw_gph:'3.0', model:'High-flow DS', notes:'Up to 150 ft hose'},
    {gpm:'5.5', ratio:'10:1', draw_oz:'7.0', draw_gph:'3.3', model:'High-flow DS', notes:'Up to 200 ft hose'},
    {gpm:'8.0', ratio:'10:1', draw_oz:'10.2', draw_gph:'4.8', model:'High-flow DS', notes:'Requires upstream for long runs'},
  ];

  let dsRows = dsData.map(d => `<tr><td>${d.gpm}</td><td>${d.ratio}</td><td>${d.draw_oz}</td><td>${d.draw_gph}</td><td>${d.model}</td><td>${d.notes}</td></tr>`).join('');

  C.innerHTML = `<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button>
    <div class="page-header"><div class="page-header-icon">ğŸ’‰</div><div><h2>Injector Sizing Chart</h2><p>Chemical draw rates by water flow and dilution ratio</p></div></div>

    <div class="card" style="overflow-x:auto">
      <h4>Downstream Injector â€” Draw Rates at 10:1 Dilution</h4>
      <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.75rem">Downstream injectors require a low-pressure (soap) nozzle to function.</p>
      <table class="ref-table">
        <thead><tr><th>Water GPM</th><th>Ratio</th><th>Chem oz/min</th><th>Chem gal/hr</th><th>Injector Type</th><th>Notes</th></tr></thead>
        <tbody>${dsRows}</tbody>
      </table>
    </div>

    <div class="card">
      <h4>Downstream vs Upstream</h4>
      <table class="ref-table">
        <thead><tr><th></th><th>Downstream</th><th>Upstream</th></tr></thead>
        <tbody>
          <tr><td><strong>Location</strong></td><td>After unloader (low pressure side)</td><td>Before unloader (high pressure side)</td></tr>
          <tr><td><strong>Draw ratio</strong></td><td>10:1 to 20:1 (lighter)</td><td>5:1 to 10:1 (stronger)</td></tr>
          <tr><td><strong>Requires</strong></td><td>Soap nozzle (low-pressure tip)</td><td>Chemical-rated HP hose</td></tr>
          <tr><td><strong>Best for</strong></td><td>House wash, fleet wash, light cleaning</td><td>Thick chemicals, long hose runs, heavy degreasing</td></tr>
          <tr><td><strong>Hose effect</strong></td><td>Draw decreases with longer hose</td><td>Less affected by hose length</td></tr>
          <tr><td><strong>Pump wear</strong></td><td>Chemical doesn't contact pump</td><td>Chemical flows through pump â€” more seal wear</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h4>Quick Rules</h4>
      <p style="font-size:0.85rem;line-height:1.8">
        ğŸ“Œ <strong>No soap?</strong> â†’ Check: soap nozzle installed? Pickup tube submerged? Injector clogged? Arrow pointing right direction?<br>
        ğŸ“Œ <strong>Weak chemical?</strong> â†’ Shorten hose, pre-mix stronger, or switch to upstream injector.<br>
        ğŸ“Œ <strong>Every 50 ft of hose</strong> reduces downstream draw rate noticeably.<br>
        ğŸ“Œ <strong>Injector orientation:</strong> Arrow must point in flow direction (toward gun).
      </p>
    </div>

    <div style="text-align:center;padding:1rem">
      <button class="quick-btn" onclick="startTopic('injector')" style="border-color:rgba(37,99,235,0.3);background:rgba(37,99,235,0.04)"><span class="qicon">ğŸ¤–</span> Ask AI to calculate my specific setup</button>
    </div>
  </div>`;
  MAIN.scrollTop=0;
}
function showHome(){setActive('home');inChat=false;document.querySelector('.input-bar').classList.add('hidden');C.innerHTML=`<div class="welcome"><div class="welcome-icon">ğŸ”§<svg class="pippie" width="42" height="58" viewBox="0 0 100 140"><rect x="28" y="45" width="44" height="60" rx="8" fill="#D4A843" stroke="#B8922E" stroke-width="2"/><rect x="33" y="51" width="14" height="6" rx="3" fill="#E8C75A" opacity="0.6"/><circle cx="50" cy="88" r="10" fill="#f0f0f0" stroke="#888" stroke-width="1.5"/><circle cx="50" cy="88" r="7" fill="white"/><line x1="50" y1="88" x2="54" y2="83" stroke="#C4382A" stroke-width="1.5" stroke-linecap="round"/><circle cx="50" cy="88" r="1.5" fill="#333"/><path d="M 38 45 L 38 28 Q 38 22 44 22 L 56 22 Q 62 22 62 28 L 62 45" fill="none" stroke="#888" stroke-width="3" stroke-linecap="round"/><rect x="42" y="15" width="16" height="10" rx="3" fill="#C4382A" stroke="#A52E22" stroke-width="1.5"/><g class="pb"><ellipse cx="41" cy="62" rx="7" ry="8" fill="white" stroke="#333" stroke-width="1.5"/><circle cx="41" cy="63" r="4.5" fill="#22C55E"/><circle cx="41" cy="63" r="2" fill="#15803D"/><circle cx="39.5" cy="61" r="1.5" fill="white"/></g><g class="pb"><ellipse cx="59" cy="62" rx="7" ry="8" fill="white" stroke="#333" stroke-width="1.5"/><circle cx="59" cy="63" r="4.5" fill="#22C55E"/><circle cx="59" cy="63" r="2" fill="#15803D"/><circle cx="57.5" cy="61" r="1.5" fill="white"/></g><path d="M 42 76 Q 50 82 58 76" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round"/><rect x="8" y="58" width="22" height="10" rx="5" fill="#B0B0B0" stroke="#888" stroke-width="1.5"/><circle cx="10" cy="63" r="4" fill="#999" stroke="#777" stroke-width="1"/><rect x="70" y="58" width="22" height="10" rx="5" fill="#B0B0B0" stroke="#888" stroke-width="1.5"/><circle cx="90" cy="63" r="4" fill="#999" stroke="#777" stroke-width="1"/><rect x="30" y="103" width="16" height="10" rx="5" fill="#B8922E" stroke="#8B6F1F" stroke-width="1.5"/><rect x="54" y="103" width="16" height="10" rx="5" fill="#B8922E" stroke="#8B6F1F" stroke-width="1.5"/><circle cx="46" cy="12" r="3.5" fill="#ddd" class="ps1" opacity="0"/><circle cx="54" cy="10" r="3" fill="#ddd" class="ps2" opacity="0"/></svg></div><h2>How can I help?</h2><div class="home-search"><div class="home-search-box"><input type="text" id="homeInput" placeholder="Describe your issue or search modelsâ€¦" autocomplete="off"/><div class="home-search-actions"><button class="upload-home" onclick="document.getElementById('imageUpload').click()" title="Upload photo">ğŸ“·</button><button class="search-send" onclick="homeSearch()" title="Send">â¤</button></div></div></div><p class="home-hint">Try: "pump losing pressure" Â· "oil for TS2021" Â· "burner won't fire"</p><div class="mobile-quick"><button class="quick-btn" onclick="startTopic('pressure')"><span class="qicon">ğŸ“‰</span> Low pressure</button><button class="quick-btn" onclick="startTopic('oil')"><span class="qicon">ğŸ›¢ï¸</span> Oil lookup</button><button class="quick-btn" onclick="startTopic('burner')"><span class="qicon">ğŸ”¥</span> Burner issues</button><button class="quick-btn" onclick="startTopic('service')"><span class="qicon">âš™ï¸</span> Service &amp; repair</button><button class="quick-btn" onclick="startTopic('chemical')"><span class="qicon">ğŸ§ª</span> Soap / Chemical</button><button class="quick-btn" onclick="startTopic('electrical')"><span class="qicon">âš¡</span> Electrical</button><button class="quick-btn" onclick="startTopic('find')"><span class="qicon">ğŸ”</span> Find a pump</button><button class="quick-btn" onclick="startTopic('maintenance')"><span class="qicon">ğŸ—“ï¸</span> Maintenance</button><button class="quick-btn" onclick="showSavedDiags()"><span class="qicon">ğŸ“‹</span> My Diagnostics</button></div><div class="mobile-quick" style="margin-top:0.5rem"><button class="quick-btn" onclick="startTopic('nozzle')" style="border-color:rgba(37,99,235,0.3);background:rgba(37,99,235,0.04)"><span class="qicon">ğŸ¯</span> Nozzle Calculator</button><button class="quick-btn" onclick="startTopic('injector')" style="border-color:rgba(37,99,235,0.3);background:rgba(37,99,235,0.04)"><span class="qicon">ğŸ’‰</span> Injector Sizing</button><button class="quick-btn" onclick="startTopic('multimeter')" style="border-color:rgba(37,99,235,0.3);background:rgba(37,99,235,0.04)"><span class="qicon">âš¡</span> Multimeter Assistant</button></div></div>`;document.getElementById('homeInput').addEventListener('keydown',e=>{if(e.key==='Enter')homeSearch()});safeFocus(document.getElementById('homeInput'));}

/* â•â•â• SEARCH â•â•â• */
function genResponse(query){const q=norm(query);let html='';let found=false;
  const pr=KB.gp.pumpModels.filter(m=>{const mn=norm(m[0]);return mn===q||q.includes(mn)||mn.includes(q);});
  if(pr.length>0&&pr.length<=20){html+=`<h4>Pump Specifications</h4><table class="data-table"><thead><tr><th>Model</th><th>GPM</th><th>PSI</th><th>RPM</th><th>HP</th><th>Wt</th><th>Series</th></tr></thead><tbody>`;for(const m of pr)html+=`<tr><td class="model-cell">${m[0]}</td><td>${m[1]}</td><td>${parseInt(m[2]).toLocaleString()}</td><td>${m[3]}</td><td>${m[4]}</td><td>${m[5]}</td><td>${m[6]}</td></tr>`;html+=`</tbody></table>`;found=true;}
  const oilR=findOil(query);if(oilR.length>0){html+=`<h4>Oil Recommendation</h4>`;for(const r of oilR)html+=`<div class="oil-result"><span class="model">${r.model}</span> â†’ <span class="oil-badge ${r.badge}">${r.oil}</span> (${r.weight})</div>`;html+=`<div class="info-block"><p>â±ï¸ ${KB.gp.maintenance.oilChange}</p></div>`;found=true;}else if(/oil|lubric|lube|what oil|which oil/.test(q)){html+=`<h4>Oil</h4><div class="info-block"><p><span class="oil-badge s100">100</span> 30W Â· <span class="oil-badge s220">220</span> 50W Â· <span class="oil-badge s8090">8090</span> 80/90 Gear Lube â€” provide model for specific rec.</p></div>`;found=true;}
  const gpmM=q.match(/(\d+\.?\d*)\s*gpm/),psiM=q.match(/(\d+)\s*psi/);if((gpmM||psiM)&&/find|need|looking|want|recommend|which|what pump|select/.test(q)){const tG=gpmM?parseFloat(gpmM[1]):null,tP=psiM?parseInt(psiM[1]):null;let r=KB.gp.pumpModels.filter(m=>{const g=parseFloat(m[1]),p=parseInt(m[2]);if(tG&&(g<tG*0.85||g>tG*1.3))return false;if(tP&&(p<tP*0.85||p>tP*1.15))return false;return true;}).slice(0,15);if(r.length>0){html+=`<h4>Matching Pumps</h4><table class="data-table"><thead><tr><th>Model</th><th>GPM</th><th>PSI</th><th>RPM</th><th>HP</th><th>Series</th></tr></thead><tbody>`;for(const m of r)html+=`<tr><td class="model-cell">${m[0]}</td><td>${m[1]}</td><td>${parseInt(m[2]).toLocaleString()}</td><td>${m[3]}</td><td>${m[4]}</td><td>${m[6]}</td></tr>`;html+=`</tbody></table>`;found=true;}}
  if(/how (do|to)|service|replace|repair|remove|install|fix|rebuild|steps|procedure/.test(q)){const procs=[];if(/valve/.test(q))procs.push(KB.gp.serviceProcedures.valves);if(/plunger/.test(q))procs.push(KB.gp.serviceProcedures.plungers);if(/v.?pack|packing|seal replace/.test(q))procs.push(KB.gp.serviceProcedures.vpackings);if(procs.length>0){for(const p of procs){html+=`<h4>${p.title}</h4>${renderSteps(p.steps)}`;if(p.notes)html+=`<div class="info-block"><p>ğŸ“Œ ${p.notes}</p></div>`;}found=true;}}
  const gpKW={pressure:["low pressure","no pressure","pressure drop","losing pressure"],pulsation:["pulsation","pulse","pulsing","surging"],rough:["rough","very low","cavitation","no output"],noise:["knock","knocking","loud noise","banging","noise","rattle"],packing:["packing failure","packing wear","premature packing"],overheating:["overheat","overheating","pump hot","running hot"],leak:["leak","leaking","drip","water leak","oil leak","milky oil","water in crankcase"]};
  // Only show the BEST matching troubleshooting category, not all
  let bestGP=null,bestGPScore=0;
  for(const[k,kws]of Object.entries(gpKW)){let score=0;for(const kw of kws){if(q.includes(kw))score+=kw.includes(' ')?3:1;}if(score>bestGPScore){bestGPScore=score;bestGP=k;}}
  if(bestGP&&!found){const t=KB.gp.troubleshooting[bestGP];if(t){html+=`<h4>${t.icon} ${t.title}</h4>`;const causes=t.causes||(t.items?t.items.flatMap(i=>i.causes):[]);html+=renderCauses(causes,3);found=true;}}
  // Only check Alkota troubleshooting if no GP match found
  if(!found){let bestAlk=null,bestAlkScore=0;for(const[key,val]of Object.entries(KB.alk.troubleshooting)){let score=0;const tw=norm(val.title).split(' ');for(const w of tw){if(w.length>3&&q.includes(w))score+=1;}for(const c of val.causes){for(const w of norm(c.cause).split(' ')){if(w.length>4&&q.includes(w))score+=1;}}if(score>bestAlkScore){bestAlkScore=score;bestAlk=key;}}if(bestAlk){const val=KB.alk.troubleshooting[bestAlk];html+=`<h4>${val.icon} ${val.title}</h4>${renderCauses(val.causes.slice(0,10),3)}`;found=true;}}
  if(/maintenance|schedule|interval|when should|how often/.test(q)&&!found){html+=`<h4>Maintenance</h4><div class="info-block"><p>${KB.gp.maintenance.oilChange}</p><p><strong>Every 500h:</strong> ${KB.gp.maintenance.every500.join(', ')}</p></div><h4 style="margin-top:1rem">Maintenance</h4>`;for(const[k,v]of Object.entries(KB.alk.maintenance.general).slice(0,4))html+=`<div class="info-block"><p><strong>${k.replace(/([A-Z])/g,' $1').trim()}:</strong> ${v}</p></div>`;found=true;}
  // Service school search
  if(KB.alk.serviceSchool&&!found){const ssts=[['pumpTroubleshooting','Pump'],['unloaderTroubleshooting','Unloader'],['oilBurnerTroubleshooting','Oil Burner'],['gasHeaterTroubleshooting','Gas Heater']];for(const[key,label]of ssts){const section=KB.alk.serviceSchool[key];if(!section)continue;for(const[prob,causes]of Object.entries(section)){const pn=norm(prob);if(pn.split(' ').some(w=>w.length>3&&q.includes(w))||causes.some(c=>norm(c.cause).split(' ').some(w=>w.length>4&&q.includes(w)))){html+=`<h4>${label}: ${prob}</h4>${renderCauses(causes,3)}`;found=true;}}}}
  if(KB.alk.serviceSchool&&!found){const refs={pumpService:['pump','head','plunger','packing','cavitation','oil'],electrical:['electrical','switch','vacuum switch','pressure switch','contactor','cad cell','gfi','timer','cam switch'],coils:['coil','descal','scale','heat exchanger','smoke test'],burners:['burner','fuel','nozzle gauge','electrode','solenoid','jet','combustion','venting','exhaust'],nozzles:['nozzle','spray tip','spray angle','soap nozzle','impact nozzle'],unloaders:['unloader','relief valve','pulse hose','accumulator','float tank','chemical inject']};for(const[key,kws]of Object.entries(refs)){if(kws.some(kw=>q.includes(kw))){const section=KB.alk.serviceSchool[key];if(section){html+=`<h4>${key.replace(/([A-Z])/g,' $1').trim()}</h4>`;if(typeof section==='object'&&!Array.isArray(section)){for(const[k,v]of Object.entries(section)){if(typeof v==='string'){const vn=norm(v);if(kws.some(kw=>vn.includes(kw))||q.split(' ').some(w=>w.length>3&&vn.includes(w))){html+=`<div class="info-block"><p><strong>${k.replace(/([A-Z])/g,' $1').trim()}:</strong> ${v}</p></div>`;}}}}found=true;break;}}}}
  if(/warranty|coverage|covered/.test(q)&&!found){html+=`<h4>Warranty</h4><div class="info-block"><p><strong>Pumps:</strong> ${KB.gp.warranty.pumpWarranty}</p><p><strong>Manifolds:</strong> ${KB.gp.warranty.manifoldWarranty}</p></div>`;found=true;}
  if(/system|motor|engine|pulley|spray tip|unloader|thermal|hose|plumbing/.test(q)&&!found){html+=`<h4>System Design</h4>`;for(const item of Object.values(KB.gp.systemDesign)){const tw=norm(item.title).split(' ');if(tw.some(w=>w.length>3&&q.includes(w)))html+=`<div class="info-block"><p><strong>${item.title}:</strong> ${item.text}</p></div>`;}found=true;}
  if(!found){const ar=[];for(const[cat,items]of Object.entries(KB.gp.accessories))for(const item of items)if(norm(item[0]).includes(q)||norm(item[1]).includes(q))ar.push({cat,part:item[0],desc:item[1]});if(ar.length>0){html+=`<h4>Accessories</h4><table class="data-table"><thead><tr><th>Part</th><th>Category</th><th>Description</th></tr></thead><tbody>`;for(const r of ar.slice(0,20))html+=`<tr><td class="model-cell">${r.part}</td><td>${r.cat}</td><td style="font-family:var(--font-body);color:var(--text-muted)">${r.desc}</td></tr>`;html+=`</tbody></table>`;found=true;}}
  if(!found)html+=`<div class="info-block"><p>I can help with:</p><p>ğŸ” Pump lookup â€” model or specs</p><p>ğŸ”§ Troubleshooting â€” pressure, leaks, noise, packing</p><p>ğŸ›¢ï¸ Oil â€” "oil for TS2021"</p><p>ğŸ”¥ Troubleshooting â€” burner, pilot, motor, temperature</p><p>ğŸ—“ï¸ Maintenance â€” schedules for both brands</p></div>`;
  return html;}

/* â•â•â• CHAT STATE â•â•â• */
let chatMessages=[];
let chatHistory=[]; // plain text history sent to API for conversation context
let chatMsgId=0;
let inChat=false;

function ensureChatView(){
  if(!inChat){
    inChat=true;
    document.querySelector('.input-bar').classList.remove('hidden');
    history.pushState({view:'chat'},'','#chat');
    C.innerHTML=`<div class="section-page"><div class="chat-nav"><button class="nav-btn" onclick="exitChat()">ğŸ  Home</button><button class="nav-btn primary" onclick="newChat()">ï¼‹ New Chat</button><button class="nav-btn" onclick="openSaveDialog()" style="margin-left:auto">ğŸ’¾ Save</button></div><div class="messages" id="chatMessages"></div></div>`;
  }
}

function exitChat(){inChat=false;chatMessages=[];chatHistory=[];chatMsgId=0;I.placeholder='Search models, troubleshoot issues, look up specs\u2026';document.querySelector('.input-bar').classList.add('hidden');showHome();}
function newChat(){chatMessages=[];chatHistory=[];chatMsgId=0;inChat=false;I.placeholder='Search models, troubleshoot issues, look up specs\u2026';ensureChatView();
  const el=document.getElementById('chatMessages');if(el)el.innerHTML='';
  inChat=true;
}

function addChatMsg(role, html){
  chatMessages.push({role,html});
  const el=document.getElementById('chatMessages');
  if(!el)return;
  if(role==='user'){
    el.innerHTML+=`<div class="msg msg-user"><div class="bubble">${html}</div></div>`;
  } else {
    chatMsgId++;
    el.innerHTML+=`<div class="msg msg-bot"><div class="bot-avatar" style="background:var(--accent);color:#fff;font-size:0.6rem;font-weight:700">AI</div><div class="bubble" id="aiText${chatMsgId}">${html}</div></div>`;
  }
  scrollBottom();
}

let _aiTruncId=0;
function formatAIText(raw){
  const MAX=600;
  let formatted=raw
    .replace(/\n\n/g,'</p><p>')
    .replace(/\n/g,'<br>')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/^/, '<p>') + '</p>';
  if(raw.length>MAX){
    _aiTruncId++;
    const cutPoint=raw.lastIndexOf(' ',MAX);
    const shortRaw=raw.substring(0,cutPoint>200?cutPoint:MAX);
    const shortHtml=shortRaw
      .replace(/\n\n/g,'</p><p>')
      .replace(/\n/g,'<br>')
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
      .replace(/^/, '<p>') + 'â€¦</p>';
    return shortHtml+`<button class="show-more-btn" onclick="this.style.display='none';document.getElementById('aiTr${_aiTruncId}').style.display='block';document.getElementById('aiSh${_aiTruncId}').style.display='none'" style="background:none;border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.8rem;cursor:pointer;font-size:0.78rem;color:var(--accent);font-family:var(--font-body);margin-top:0.5rem" id="aiSh${_aiTruncId}">Show full response â–¾</button><div id="aiTr${_aiTruncId}" style="display:none">${formatted}</div>`;
  }
  return formatted;
}

function showSearch(query,img){setActive('home');
  ensureChatView();
  const imgHtml=img?`<img src="data:${img.mediaType};base64,${img.data}" class="img-in-chat" alt="Uploaded photo"/><br>`:'';
  addChatMsg('user', imgHtml+esc(query));
  addChatMsg('bot', `<span class="ai-loading">ğŸ” Searchingâ€¦</span>`);
  const myId=chatMsgId;
  
  // Build request with conversation history
  const body={message:query, history:chatHistory};
  if(img){body.image=img.data;body.image_type=img.mediaType;}
  
  // Track user message in history for next request
  chatHistory.push({role:'user', content:query});
  
  fetch('/api/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({...body, session_id: SESSION_ID})
  }).then(r=>r.json()).then(data=>{
    const el=document.getElementById('aiText'+myId);
    if(!el)return;
    if(data.reply){
      el.innerHTML=formatAIText(data.reply);
      // Track assistant reply in history for next request
      chatHistory.push({role:'assistant', content:data.reply});
      I.placeholder='Type your reply or ask a follow-up question...';
      safeFocus(I);
      // Add save + feedback buttons after AI bubble
      injectSaveButton(el);
      if(data.log_id) injectFeedbackButtons(el, data.log_id);
      var userMsgs=document.querySelectorAll('.msg-user');
      var lastUser=userMsgs[userMsgs.length-1];
      if(lastUser)scrollToMsg(lastUser);
    } else if(data.error){
      el.innerHTML='<span style="color:var(--text-muted)">AI unavailable: '+esc(data.error)+'</span>';
    }
    scrollBottom();
  }).catch(e=>{
    const el=document.getElementById('aiText'+myId);
    if(el) el.innerHTML=img?'<span style="color:var(--text-muted)">Image analysis requires AI agent.</span>':genResponse(query);
  });
}

/* â•â•â• CONVERSATIONAL FLOW â•â•â• */
function startTopic(topic){
  const topicLabels={pressure:'Low Pressure',oil:'Oil Lookup',burner:'Burner Issues',service:'Service & Repair',chemical:'Chemical Issues',find:'Find a Pump',pilot:'Pilot Light',maintenance:'Maintenance',leak:'Leaks',noise:'Noise',packing:'Packing Failure',overheating:'Overheating',rough:'Rough Running',pulsation:'Pulsation',valves:'Valve Service',plungers:'Plunger Replacement',vpackings:'V-Packing Replacement',catalog:'Product Catalog',accessories:'Accessories',system:'System Design',warranty:'Warranty',electrical:'Electrical',coils:'Coils & Heat Exchangers',nozzles:'Spray Nozzles',unloaders:'Unloaders',checklist:'Pre-Service Checklist',installation:'Installation',startup:'Start-Up Procedure',nozzle:'Nozzle Calculator',injector:'Injector Sizing',multimeter:'Multimeter Assistant'};
  const label=topicLabels[topic]||topic;
  setActive('home');
  ensureChatView();

  const topicOptions={
    pressure:[
      ['ğŸ“‰','Pressure drops during use','My pressure drops while I am spraying'],
      ['â›”','No pressure at all','My pump is running but I have no pressure output'],
      ['ğŸ“Š','Pressure is lower than rated','My pump pressure is lower than what it should be rated for'],
      ['ğŸ’§','Pressure fluctuates up and down','My pressure is surging or fluctuating up and down']
    ],
    oil:[
      ['ğŸ›¢ï¸','Need oil recommendation','What oil does my pump need? I need the model-specific recommendation'],
      ['ğŸ”„','When to change oil','How often should I change my pump oil and what is the procedure?'],
      ['ğŸ¥›','Oil looks milky or contaminated','My pump oil looks milky or has water in it']
    ],
    burner:[
      ['ğŸ”¥','Won\'t fire','Burner will not fire at all'],
      ['ğŸ’¨','Pilot won\'t stay lit','Pilot will not stay lit'],
      ['âš ï¸','Fires then shuts off','Burner fires but shuts off after a short time'],
      ['ğŸŒ«ï¸','Smoke / soot','There is smoke or soot coming from the burner']
    ],
    service:[
      ['ğŸ”§','Pump rebuild','I need to rebuild or service my pump'],
      ['âš™ï¸','Replace seals or packings','I need to replace seals or v-packings on my pump'],
      ['ğŸ”©','Replace valves','I need to replace or service the check valves'],
      ['ğŸ“‹','General service steps','What are the general service procedures for my equipment?']
    ],
    chemical:[
      ['ğŸ§ª','Won\'t draw chemical','My machine will not draw chemical or detergent'],
      ['ğŸ’§','Chemical is too weak','Chemical is being applied but it is too diluted or weak'],
      ['ğŸš«','Chemical injector leaking','My chemical injector is leaking or dripping'],
      ['â“','Injector setup help','How do I set up or adjust my chemical injection system?']
    ],
    find:[
      ['ğŸ“Š','By GPM and PSI','I need a pump with specific GPM and PSI ratings'],
      ['ğŸ—ï¸','By application','I need a pump recommendation for a specific application'],
      ['ğŸ”„','Replacement pump','I need to find a replacement pump for my current one'],
      ['ğŸ“‹','Compare models','I want to compare pump models and specifications']
    ],
    pilot:[
      ['ğŸ”¥','Won\'t ignite','Pilot will not ignite at all'],
      ['ğŸ’¨','Won\'t stay lit','Pilot lights but will not stay lit'],
      ['âš¡','Ignitor not sparking','The ignitor is not producing a spark'],
      ['ğŸŒ¬ï¸','Blows out easily','Pilot blows out in wind or during operation']
    ],
    maintenance:[
      ['ğŸ—“ï¸','Maintenance schedule','What is the recommended maintenance schedule for my equipment?'],
      ['â„ï¸','Winterizing','How do I winterize or store my pressure washer for the season?'],
      ['â–¶ï¸','Start-up procedure','What is the proper start-up procedure?'],
      ['ğŸ›‘','Shutdown procedure','What is the proper shutdown procedure?']
    ],
    nozzle:[
      ['ğŸ¯','Size a nozzle','I need to find the right nozzle size for my setup'],
      ['ğŸ“Š','Check my nozzle','I have a nozzle and want to know what GPM it delivers at my PSI'],
      ['ğŸ”„','Nozzle is worn','My nozzle seems worn â€” I am losing pressure']
    ],
    injector:[
      ['ğŸ’‰','Size an injector','I need to size a chemical injector for my system'],
      ['ğŸ“','Calculate draw rate','I want to know how much chemical my injector will use per hour'],
      ['ğŸ”§','Injector not drawing','My chemical injector is not drawing soap']
    ],
    multimeter:[
      ['âš¡','Machine is dead','My machine has no power at all â€” walk me through testing it'],
      ['ğŸ”Œ','Motor hums but won\'t spin','Motor hums but won\'t turn â€” could be capacitor'],
      ['ğŸ”¥','Burner shuts off (CAD cell)','Burner fires then locks out â€” need to test the flame sensor'],
      ['âš ï¸','Keeps tripping GFCI','Machine trips the GFCI every time I plug it in']
    ],
    electrical:[
      ['âš¡','Machine won\'t start','My machine is completely dead and won\'t start at all'],
      ['ğŸ”Œ','Trips breaker','My machine trips the breaker or GFCI when I turn it on'],
      ['ã€°ï¸','Intermittent power','Machine starts and stops, or works sometimes but not others'],
      ['ğŸ”Š','Motor hums but won\'t spin','Motor makes a humming noise but the shaft won\'t turn']
    ]
  };

  const options=topicOptions[topic];
  if(options){
    let btns=options.map(([icon,label,q])=>
      `<button class="quick-btn" onclick="askQ('${q.replace(/'/g,"\\'")}')"><span class="qicon">${icon}</span> ${label}</button>`
    ).join('');
    addChatMsg('bot',`<p>I can help with <strong>${esc(topicLabels[topic])}</strong>. What's going on?</p>
      <div class="quick-actions" style="margin-top:0.75rem">${btns}</div>
      <p style="margin-top:0.5rem;font-size:0.82rem;color:var(--text-muted)">Or type your own description below.</p>`);
    safeFocus(I);I.placeholder='Describe your issue or ask a question...';
    scrollBottom();
    return;
  }

  // Fallback for sidebar topics without custom options â€” send straight to AI
  showSearch('I need help with '+label+'. What should I know?');
}

/* â•â•â• ROUTING â•â•â• */
function nav(t){
  if(t==='home')return showHome();
  // Strip prefix and route through conversational flow
  if(t.startsWith('gp-')){const topic=t.slice(3);startTopic(topic);return;}
  if(t.startsWith('alk-ts-')){const topic=t.slice(7);startTopic(topic);return;}
  if(t.startsWith('alk-')){const topic=t.slice(4);startTopic(topic);return;}
  startTopic(t);
}

function homeSearch(){const hi=document.getElementById('homeInput');if(!hi)return;const q=hi.value.trim();if(!q&&!pendingImage)return;hi.value='';const img=pendingImage;clearImage();showSearch(q||'Identify this equipment and any visible issues.',img);}

function handleSend(){const q=I.value.trim();if(!q&&!pendingImage)return;I.value='';I.placeholder='Search models, troubleshoot issues, look up specs...';
  const img=pendingImage;clearImage();
  if(window._pendingContext){const full=window._pendingContext+(q||'');window._pendingContext=null;showSearch(full,img);return;}
  // If input is numbers only, ask for full model number
  if(!img && /^\d+$/.test(q)){
    ensureChatView();
    addChatMsg('user', esc(q));
    addChatMsg('bot', `<p>It looks like you entered just a number. Could you provide the <strong>full model number</strong> including letters? For example: <strong>TS2021</strong>, <strong>EZ4040G</strong>, <strong>KFMZ</strong>, etc.</p>`);
    safeFocus(I);I.placeholder='e.g. TS2021, EZ4040G, T1011...';
    window._pendingContext='Look up pump model ';
    return;
  }
  showSearch(q||'Identify this equipment and any visible issues.',img);
}
function askQ(q){I.value=q;handleSend();}
I.addEventListener('keydown',e=>{if(e.key==='Enter')handleSend()});

console.log('[Init] C=', !!C, 'I=', !!I, 'SB=', !!SB);
buildSidebar();if(C)showHome();else console.error('[Init] contentArea not found');if(I)safeFocus(I);
document.addEventListener('click',function(e){const m=document.getElementById('hamMenu');if(m&&!e.target.closest('.hamburger')&&!e.target.closest('.ham-menu'))m.classList.remove('open');});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVED DIAGNOSTICS â€” Save, Browse, View, Download, Delete
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function openSaveDialog(){
  // Gather conversation from chat
  const convo = chatHistory.map(m => ({role:m.role, content:m.content}));
  const lastAI = [...chatHistory].reverse().find(m=>m.role==='assistant');
  
  document.getElementById('saveModal').classList.add('open');
  document.getElementById('saveTitleInput').value = '';
  document.getElementById('saveMachineInput').value = '';
  document.getElementById('saveBrandInput').value = '';
  document.getElementById('saveModelInput').value = '';
  document.getElementById('saveSerialInput').value = '';
  document.getElementById('saveCategoryInput').value = '';
  document.getElementById('saveSeverityInput').value = 'medium';
  document.getElementById('saveDiagInput').value = '';
  document.getElementById('saveStepsInput').value = '';
  document.getElementById('savePartsInput').value = '';
  document.getElementById('saveNotesInput').value = '';
  document.getElementById('saveConvoData').value = JSON.stringify(convo);
  
  // Auto-fill title from first user message
  const firstMsg = chatHistory.find(m=>m.role==='user');
  if(firstMsg) document.getElementById('saveTitleInput').value = firstMsg.content.substring(0, 80);
  
  document.getElementById('saveTitleInput').focus();
}

function closeSaveDialog(){
  document.getElementById('saveModal').classList.remove('open');
}

async function confirmSave(){
  const data = {
    title: document.getElementById('saveTitleInput').value || 'Untitled',
    machine_name: document.getElementById('saveMachineInput').value || null,
    machine_brand: document.getElementById('saveBrandInput').value || null,
    machine_model: document.getElementById('saveModelInput').value || null,
    machine_serial: document.getElementById('saveSerialInput').value || null,
    category: document.getElementById('saveCategoryInput').value || null,
    severity: document.getElementById('saveSeverityInput').value || null,
    diagnosis: document.getElementById('saveDiagInput').value || null,
    steps: document.getElementById('saveStepsInput').value ? document.getElementById('saveStepsInput').value.split('\n').filter(s=>s.trim()) : null,
    parts_used: document.getElementById('savePartsInput').value ? document.getElementById('savePartsInput').value.split('\n').filter(s=>s.trim()) : null,
    notes: document.getElementById('saveNotesInput').value || null,
    conversation: JSON.parse(document.getElementById('saveConvoData').value || '[]')
  };

  try {
    const r = await fetch('/api/saved-diags', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    const result = await r.json();
    if(result.id){
      closeSaveDialog();
      // Mark save button as saved
      const btn = document.querySelector('.save-btn:not(.saved)');
      if(btn){btn.classList.add('saved');btn.innerHTML='âœ… Saved';}
      // Brief toast
      showToast('Diagnostic saved â€” #' + result.id);
    } else {
      alert('Save failed: '+(result.error||'Unknown error'));
    }
  } catch(e){
    alert('Save failed: '+e.message);
  }
}

function showToast(msg){
  const t=document.createElement('div');
  t.style.cssText='position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#16a34a;color:#fff;padding:10px 20px;border-radius:10px;font-size:0.85rem;font-family:var(--font-body);z-index:10000;animation:fadeUp 0.3s';
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 2500);
}

async function showSavedDiags(){
  setActive('saved-diags');
  inChat=false;
  document.querySelector('.input-bar').classList.add('hidden');
  C.innerHTML='<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ“‹</div><div><h2>Saved Diagnostics</h2><p>Your diagnostic history</p></div></div><div id="diagListContainer"><div style="text-align:center;padding:2rem;color:var(--text-muted)">Loading...</div></div></div>';
  
  try {
    const r = await fetch('/api/saved-diags');
    const diags = await r.json();
    const container = document.getElementById('diagListContainer');
    
    if(!diags.length){
      container.innerHTML='<div class="diag-empty"><div class="diag-empty-icon">ğŸ“‹</div><p>No saved diagnostics yet</p><p style="font-size:0.82rem;margin-top:0.5rem">After diagnosing a problem in chat, click <strong>ğŸ’¾ Save Diagnosis</strong> to keep a record.</p></div>';
      return;
    }
    
    let html='<div class="diag-list">';
    for(const d of diags){
      const date = new Date(d.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
      html+=`<div class="diag-card" onclick="viewSavedDiag(${d.id})">
        <div class="diag-card-header">
          <div>
            <h4>${esc(d.title)}</h4>
            <div class="diag-meta">${date}${d.category?' Â· <span class="diag-category">'+esc(d.category)+'</span>':''}${d.severity?' Â· <span class="sev-badge sev-'+d.severity+'">'+d.severity.toUpperCase()+'</span>':''}</div>
            ${d.machine_name||d.machine_model?'<div class="diag-machine">ğŸ”§ '+(d.machine_name?esc(d.machine_name):'')+(d.machine_model?' Â· '+esc(d.machine_model):'')+'</div>':''}
          </div>
          <div class="diag-card-actions" onclick="event.stopPropagation()">
            <button class="dl-btn" onclick="downloadDiag(${d.id})" title="Download report">ğŸ“„</button>
            <button class="del-btn" onclick="deleteDiag(${d.id},'${esc(d.title).replace(/'/g,"\\'")}')" title="Delete">ğŸ—‘</button>
          </div>
        </div>
      </div>`;
    }
    html+='</div>';
    container.innerHTML=html;
  } catch(e){
    document.getElementById('diagListContainer').innerHTML='<div style="color:var(--text-muted);text-align:center;padding:2rem">Failed to load: '+e.message+'</div>';
  }
}

async function viewSavedDiag(id){
  C.innerHTML='<div class="section-page"><button class="back-btn" onclick="showSavedDiags()">â† Back to List</button><div style="text-align:center;padding:2rem;color:var(--text-muted)">Loading...</div></div>';
  
  try {
    const r = await fetch('/api/saved-diags/'+id);
    const d = await r.json();
    const date = new Date(d.created_at).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'});
    
    let html='<div class="section-page"><button class="back-btn" onclick="showSavedDiags()">â† Back to List</button>';
    html+='<div class="diag-detail-header"><div><h2 style="font-size:1.3rem;margin-bottom:0.25rem">'+esc(d.title)+'</h2>';
    html+='<div style="font-size:0.78rem;color:var(--text-muted)">'+date+'</div></div>';
    html+='<div class="diag-detail-actions"><button class="nav-btn" onclick="downloadDiag('+d.id+')">ğŸ“„ Download Report</button>';
    html+='<button class="nav-btn" style="color:#ef4444;border-color:#ef4444" onclick="deleteDiag('+d.id+',\''+esc(d.title).replace(/'/g,"\\'")+'\')">ğŸ—‘ Delete</button></div></div>';
    
    // Machine info
    if(d.machine_name||d.machine_brand||d.machine_model||d.machine_serial){
      html+='<div class="card" style="margin-bottom:1rem"><h4>Machine Info</h4><div class="meta-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-top:0.5rem;font-size:0.85rem">';
      if(d.machine_name) html+='<div><span style="color:var(--text-muted);font-size:0.72rem">NAME</span><br>'+esc(d.machine_name)+'</div>';
      if(d.machine_brand) html+='<div><span style="color:var(--text-muted);font-size:0.72rem">BRAND</span><br>'+esc(d.machine_brand)+'</div>';
      if(d.machine_model) html+='<div><span style="color:var(--text-muted);font-size:0.72rem">MODEL</span><br>'+esc(d.machine_model)+'</div>';
      if(d.machine_serial) html+='<div><span style="color:var(--text-muted);font-size:0.72rem">SERIAL</span><br>'+esc(d.machine_serial)+'</div>';
      html+='</div></div>';
    }
    
    // Category + severity
    if(d.category||d.severity){
      html+='<div style="display:flex;gap:0.75rem;margin-bottom:1rem;flex-wrap:wrap">';
      if(d.category) html+='<span class="diag-category" style="font-size:0.8rem;padding:0.25rem 0.75rem">'+esc(d.category)+'</span>';
      if(d.severity) html+='<span class="sev-badge sev-'+d.severity+'" style="font-size:0.75rem;padding:3px 12px">'+d.severity.toUpperCase()+'</span>';
      html+='</div>';
    }
    
    // Diagnosis
    if(d.diagnosis){
      html+='<div class="card" style="margin-bottom:1rem;background:var(--accent-dim);border-color:var(--accent)"><h4>Diagnosis</h4><p style="margin-top:0.4rem;font-size:0.88rem;line-height:1.6">'+esc(d.diagnosis)+'</p></div>';
    }
    
    // Steps
    if(Array.isArray(d.steps)&&d.steps.length){
      html+='<div class="card" style="margin-bottom:1rem"><h4>Diagnostic Steps</h4><div style="margin-top:0.5rem">';
      d.steps.forEach((s,i)=>{
        html+='<div style="display:flex;gap:0.75rem;padding:0.5rem 0;border-bottom:1px solid var(--border);font-size:0.85rem"><span style="color:var(--accent);font-weight:700;min-width:1.5rem">'+(i+1)+'</span><span>'+esc(s)+'</span></div>';
      });
      html+='</div></div>';
    }
    
    // Parts
    if(Array.isArray(d.parts_used)&&d.parts_used.length){
      html+='<div class="card" style="margin-bottom:1rem"><h4>Parts Used / Needed</h4><div style="margin-top:0.5rem;display:flex;flex-wrap:wrap;gap:0.4rem">';
      d.parts_used.forEach(p=>{html+='<span class="tag" style="font-size:0.78rem;padding:0.2rem 0.6rem">'+esc(p)+'</span>';});
      html+='</div></div>';
    }
    
    // Notes
    if(d.notes){
      html+='<div class="card" style="margin-bottom:1rem;background:rgba(245,158,11,0.04);border-color:rgba(245,158,11,0.2)"><h4>ğŸ“ Notes</h4><p style="margin-top:0.4rem;font-size:0.85rem;line-height:1.6;white-space:pre-wrap">'+esc(d.notes)+'</p></div>';
    }
    
    // Conversation
    if(Array.isArray(d.conversation)&&d.conversation.length){
      html+='<div class="card" style="margin-bottom:1rem"><h4>Full Conversation</h4><div style="margin-top:0.5rem">';
      d.conversation.forEach(m=>{
        const isUser=m.role==='user';
        html+='<div style="padding:0.6rem 0.75rem;border-bottom:1px solid var(--border);background:'+(isUser?'var(--accent-dim)':'transparent')+'">';
        html+='<div style="font-size:0.68rem;font-weight:700;color:'+(isUser?'var(--accent)':'#16a34a')+';text-transform:uppercase;margin-bottom:0.2rem">'+(isUser?'You':'P-Supp AI')+'</div>';
        html+='<div style="font-size:0.83rem;line-height:1.55;white-space:pre-wrap">'+esc(m.content||'')+'</div></div>';
      });
      html+='</div></div>';
    }
    
    html+='</div>';
    C.innerHTML=html;
    MAIN.scrollTop=0;
  } catch(e){
    C.innerHTML='<div class="section-page"><button class="back-btn" onclick="showSavedDiags()">â† Back</button><p style="color:var(--text-muted)">Error loading diagnostic: '+e.message+'</p></div>';
  }
}

function downloadDiag(id){
  window.open('/api/saved-diags/'+id+'/report','_blank');
}

async function deleteDiag(id, title){
  if(!confirm('Delete "'+title+'"? This cannot be undone.')) return;
  try {
    await fetch('/api/saved-diags/'+id, {method:'DELETE'});
    showToast('Diagnostic deleted');
    showSavedDiags();
  } catch(e){
    alert('Delete failed: '+e.message);
  }
}

// Inject save button after AI responds in chat
function injectSaveButton(afterEl){
  if(!afterEl) return;
  // Find the parent .msg div and add save button after it
  const msgDiv = afterEl.closest('.msg');
  if(!msgDiv) return;
  const existing = msgDiv.parentElement.querySelector('.save-btn');
  if(existing) return;
  const btn = document.createElement('button');
  btn.className = 'save-btn';
  btn.innerHTML = 'ğŸ’¾ Save Diagnosis';
  btn.onclick = openSaveDialog;
  msgDiv.after(btn);
}

function injectFeedbackButtons(afterEl, logId){
  if(!afterEl || !logId) return;
  const msgDiv = afterEl.closest('.msg');
  if(!msgDiv) return;
  if(msgDiv.parentElement.querySelector('.feedback-row')) return;
  const row = document.createElement('div');
  row.className = 'feedback-row';
  row.innerHTML = `<span class="feedback-label">Helpful?</span><button class="fb-btn fb-up" onclick="sendFeedback(${logId}, 1, this)" title="Helpful">ğŸ‘</button><button class="fb-btn fb-down" onclick="sendFeedback(${logId}, -1, this)" title="Not helpful">ğŸ‘</button>`;
  // Insert after save button if present, otherwise after msg
  const saveBtn = msgDiv.nextElementSibling?.classList?.contains('save-btn') ? msgDiv.nextElementSibling : null;
  if(saveBtn) saveBtn.after(row); else msgDiv.after(row);
}

function sendFeedback(logId, rating, btn){
  const row = btn.closest('.feedback-row');
  row.querySelectorAll('.fb-btn').forEach(b => b.classList.remove('fb-active'));
  btn.classList.add('fb-active');
  row.querySelector('.feedback-label').textContent = rating > 0 ? 'Thanks! ğŸ‘' : 'Noted â€” we\'ll improve';
  fetch('/api/feedback', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({log_id: logId, rating})
  }).catch(()=>{});
  // Show correction box on thumbs-down
  const existing = row.parentElement.querySelector('.correction-box');
  if(existing) existing.remove();
  if(rating === -1){
    const box = document.createElement('div');
    box.className = 'correction-box';
    box.innerHTML = `<textarea placeholder="What should the answer have been? (optional)" id="corr${logId}"></textarea><br><button onclick="submitCorrection(${logId}, this)">Submit correction</button>`;
    row.after(box);
  }
}

function submitCorrection(logId, btn){
  const box = btn.closest('.correction-box');
  const text = box.querySelector('textarea').value.trim();
  if(!text){box.remove();return;}
  fetch('/api/feedback', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({log_id: logId, rating: -1, correction: text})
  }).catch(()=>{});
  box.innerHTML = '<span class="correction-sent">âœ“ Correction saved â€” thank you!</span>';
  setTimeout(()=>{ box.style.opacity='0.5'; }, 2000);
}
</script>

<!-- Save Diagnostic Modal -->
<div class="save-modal-overlay" id="saveModal">
  <div class="save-modal">
    <h3>ğŸ’¾ Save Diagnostic Report</h3>
    <div class="save-field">
      <label>Title *</label>
      <input type="text" id="saveTitleInput" placeholder="e.g., Low pressure on Unit #3"/>
    </div>
    <div class="save-row">
      <div class="save-field"><label>Machine Name</label><input type="text" id="saveMachineInput" placeholder="e.g., Bay 2 Hot Water"/></div>
      <div class="save-field"><label>Brand</label><input type="text" id="saveBrandInput" placeholder="e.g., General Pump"/></div>
    </div>
    <div class="save-row">
      <div class="save-field"><label>Model</label><input type="text" id="saveModelInput" placeholder="e.g., TS2021"/></div>
      <div class="save-field"><label>Serial #</label><input type="text" id="saveSerialInput" placeholder="e.g., GP-2024-0847"/></div>
    </div>
    <div class="save-row">
      <div class="save-field"><label>Category</label>
        <select id="saveCategoryInput">
          <option value="">Select...</option>
          <option value="Flow / Pressure">Flow / Pressure</option>
          <option value="Heat / Burner">Heat / Burner</option>
          <option value="Electrical">Electrical</option>
          <option value="Leak">Leak</option>
          <option value="Noise / Vibration">Noise / Vibration</option>
          <option value="Engine">Engine</option>
          <option value="Packing / Seals">Packing / Seals</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="save-field"><label>Severity</label>
        <select id="saveSeverityInput">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
          <option value="critical">Critical</option>
        </select>
      </div>
    </div>
    <div class="save-field"><label>Diagnosis / Conclusion</label><textarea id="saveDiagInput" placeholder="What was the root cause?"></textarea></div>
    <div class="save-field"><label>Steps Taken (one per line)</label><textarea id="saveStepsInput" rows="4" placeholder="Checked inlet pressure&#10;Replaced HP packing kit&#10;Tested at full PSI â€” holding steady"></textarea></div>
    <div class="save-field"><label>Parts Used / Needed (one per line)</label><textarea id="savePartsInput" rows="3" placeholder="HP Packing Kit #69591&#10;Plunger #22mm&#10;O-ring set"></textarea></div>
    <div class="save-field"><label>Notes</label><textarea id="saveNotesInput" placeholder="Additional observations, follow-up needed, etc."></textarea></div>
    <input type="hidden" id="saveConvoData" value="[]"/>
    <div class="save-actions">
      <button class="cancel-btn" onclick="closeSaveDialog()">Cancel</button>
      <button class="confirm-btn" onclick="confirmSave()">ğŸ’¾ Save Diagnostic</button>
    </div>
  </div>
</div>
</div><!-- end appContent -->
<style>
.pwa-install-bar{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:0.75rem 1.5rem;display:flex;align-items:center;justify-content:space-between;z-index:200;box-shadow:0 -4px 12px rgba(0,0,0,0.06);transform:translateY(100%);transition:transform 0.3s}
.pwa-install-bar.show{transform:translateY(0)}
.pwa-install-bar .install-text{font-size:0.85rem;color:var(--text)}
.pwa-install-bar .install-text small{color:var(--text-muted);display:block;font-size:0.72rem}
.pwa-install-btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 18px;font-size:0.82rem;font-family:var(--font-body);font-weight:600;cursor:pointer}
.pwa-install-btn:hover{opacity:0.9}
.pwa-dismiss{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;padding:4px 8px}
</style>
<div class="pwa-install-bar" id="pwaBar">
  <div class="install-text">Install P-Supp<small>Add to home screen for quick access</small></div>
  <div style="display:flex;gap:0.5rem;align-items:center">
    <button class="pwa-install-btn" id="pwaInstallBtn">Install</button>
    <button class="pwa-dismiss" onclick="document.getElementById('pwaBar').classList.remove('show');sessionStorage.setItem('pwaDismissed','1')">âœ•</button>
  </div>
</div>
<script>
// Register service worker
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(r=>console.log('[PWA] SW registered')).catch(e=>console.log('[PWA] SW error:',e));
}
// Install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  if(!sessionStorage.getItem('pwaDismissed')){
    document.getElementById('pwaBar').classList.add('show');
  }
});
document.getElementById('pwaInstallBtn').addEventListener('click', async () => {
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  console.log('[PWA] Install:', result.outcome);
  deferredPrompt = null;
  document.getElementById('pwaBar').classList.remove('show');
});
window.addEventListener('appinstalled', () => {
  document.getElementById('pwaBar').classList.remove('show');
  console.log('[PWA] Installed');
});

// â”€â”€â”€ Mobile Keyboard Fix â”€â”€â”€
if(isMobile && window.visualViewport){
  const app = document.querySelector('.app');
  const adjustForKeyboard = () => {
    if(app) app.style.height = window.visualViewport.height + 'px';
  };
  window.visualViewport.addEventListener('resize', adjustForKeyboard);
  window.visualViewport.addEventListener('scroll', adjustForKeyboard);
}

// â”€â”€â”€ iOS Install Hint â”€â”€â”€
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
if(isIOS && !isStandalone && !sessionStorage.getItem('pwaDismissed')){
  setTimeout(() => {
    const bar = document.getElementById('pwaBar');
    if(bar){
      bar.querySelector('.install-text').innerHTML = '<strong>Install P-Supp</strong><small>Tap <span style="font-size:1.1em">â™</span> Share â†’ "Add to Home Screen"</small>';
      bar.querySelector('.pwa-install-btn').style.display = 'none';
      bar.classList.add('show');
    }
  }, 3000);
}
</script>
</body>
</html>
