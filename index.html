<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#2563eb">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="P-Supp">
<meta name="description" content="Equipment diagnostics, service & reference for pressure washer equipment">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192x192.png">
<title>P-Supp Tool</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f5f7fa;--surface:#ffffff;--surface-2:#f0f2f5;--surface-3:#e8ebf0;--border:#d8dce5;--text:#1a1d24;--text-muted:#5f6b7a;--accent:#2563eb;--accent-dim:rgba(37,99,235,0.08);--success:#16a34a;--blue:#0ea5e9;--blue-dim:rgba(14,165,233,0.08);--radius:12px;--font-body:'DM Sans',sans-serif;--font-mono:'Space Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:-200px;left:50%;transform:translateX(-50%);width:800px;height:600px;background:radial-gradient(ellipse,rgba(37,99,235,0.04) 0%,transparent 70%);pointer-events:none;z-index:0}
.app{position:relative;z-index:1;display:flex;flex-direction:column;height:100vh;height:100dvh}
header{border-bottom:1px solid var(--border);padding:1rem 2rem;display:flex;align-items:center;gap:1rem;background:rgba(255,255,255,0.92);backdrop-filter:blur(20px);flex-shrink:0;z-index:100}
.logo{width:44px;height:44px;background:var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-weight:700;font-size:0.7rem;color:#fff;flex-shrink:0}
.header-text h1{font-size:1.1rem;font-weight:700;letter-spacing:-0.3px}
.header-text span{font-size:0.75rem;color:var(--text-muted);font-weight:300}
.header-stats{margin-left:auto;display:flex;gap:1.5rem}
.stat{text-align:center}
.stat-val{font-family:var(--font-mono);font-size:1rem;font-weight:700;color:var(--accent)}
.stat-label{font-size:0.62rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
@media(max-width:700px){.header-stats{display:none}}
.header-right{margin-left:auto;display:flex;align-items:center;gap:0.75rem}
.hamburger{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 8px;cursor:pointer;display:flex;flex-direction:column;gap:3px;position:relative}
.hamburger span{display:block;width:18px;height:2px;background:var(--text-muted);border-radius:1px;transition:0.2s}
.hamburger:hover span{background:var(--accent)}
.ham-menu{display:none;position:absolute;top:calc(100% + 8px);right:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1rem 1.25rem;box-shadow:0 8px 24px rgba(0,0,0,0.08);z-index:200;min-width:200px}
.ham-menu.open{display:flex;gap:1.5rem}
.logout-btn{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;font-size:0.75rem;font-family:var(--font-body);color:var(--text-muted);cursor:pointer;transition:0.2s;white-space:nowrap}
.logout-btn:hover{border-color:#ef4444;color:#ef4444;background:rgba(239,68,68,0.06)}
.upload-btn{background:none;border:1px solid var(--border);border-radius:10px;padding:6px 12px;cursor:pointer;color:var(--text-muted);font-size:0.82rem;font-family:var(--font-body);transition:0.2s;display:flex;align-items:center;gap:0.3rem;white-space:nowrap}
.upload-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.img-preview-bar{display:flex;align-items:center;gap:0.5rem;padding:0.4rem 1rem;background:var(--surface-2);border-bottom:1px solid var(--border);font-size:0.78rem;color:var(--text-muted)}
.img-preview-bar img{width:40px;height:40px;object-fit:cover;border-radius:6px;border:1px solid var(--border)}
.img-preview-bar .remove-img{background:none;border:none;color:#ef4444;cursor:pointer;font-size:1rem;padding:0 4px}
.img-in-chat{max-width:240px;border-radius:8px;border:1px solid var(--border);margin-bottom:0.5rem}
.typing-cursor::after{content:'â–Š';animation:blink 0.7s infinite;color:var(--accent);font-weight:300}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.input-bar{padding:0.75rem 2rem;border-top:1px solid var(--border);background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);position:fixed;bottom:0;left:0;right:0;z-index:99}
.input-wrap{max-width:820px;margin:0 auto;display:flex;gap:0.5rem}
.input-wrap input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:16px;outline:none;transition:border-color 0.2s}
.input-wrap input:focus{border-color:var(--accent)}
.input-wrap input::placeholder{color:var(--text-muted)}
.send-btn{border-radius:12px;border:none;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.35rem;font-size:0.85rem;font-weight:600;font-family:var(--font-body);transition:all 0.15s;flex-shrink:0;padding:0 1rem;height:44px}
.send-btn:hover{filter:brightness(1.15);transform:scale(1.04)}
.layout{display:grid;grid-template-columns:260px 1fr;flex:1;overflow:hidden}
@media(max-width:900px){.layout{grid-template-columns:1fr}.sidebar{display:none}}
@media(max-width:600px){
  .upload-btn span.btn-label,.send-btn span.btn-label{display:none}
  .send-btn{width:44px;padding:0}
  .upload-btn{padding:6px 10px}
  .nav-btn{font-size:0.78rem;padding:0.45rem 0.85rem}
  .input-bar{padding:0.6rem 1rem}
  .quick-actions{grid-template-columns:1fr 1fr}
}
.sidebar{background:var(--surface);border-right:1px solid var(--border);overflow-y:auto}
.sb-section{border-bottom:1px solid var(--border)}
.sb-header{display:flex;align-items:center;gap:0.6rem;padding:0.65rem 1rem;cursor:pointer;user-select:none;transition:background 0.15s}
.sb-header:hover{background:var(--surface-2)}
.sb-chevron{font-size:0.6rem;color:var(--text-muted);transition:transform 0.25s;width:12px;text-align:center}
.sb-section.collapsed .sb-chevron{transform:rotate(-90deg)}
.sb-brand{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1px}
.sb-brand.gp{color:var(--accent)}
.sb-brand.alk{color:var(--blue)}
.sb-count{font-size:0.6rem;color:var(--text-muted);font-family:var(--font-mono);margin-left:auto}
.sb-body{overflow:hidden;transition:max-height 0.3s ease}
.sb-section.collapsed .sb-body{max-height:0 !important}
.sb-group-label{padding:0.25rem 1rem 0.15rem 2.2rem;font-size:0.62rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-top:0.3rem}
.topic-btn{display:flex;align-items:center;gap:0.55rem;width:100%;border:none;background:transparent;color:var(--text-muted);padding:0.45rem 1rem 0.45rem 2.2rem;cursor:pointer;font-size:0.8rem;font-family:var(--font-body);transition:all 0.15s;text-align:left}
.topic-btn:hover{background:var(--surface-2);color:var(--text)}
.topic-btn.active{background:var(--accent-dim);color:var(--accent);font-weight:600;border-right:3px solid var(--accent)}
.topic-btn.active.alk-active{background:var(--blue-dim);color:var(--blue);border-right-color:var(--blue)}
.topic-icon{font-size:0.85rem;width:1.1rem;text-align:center}
.home-btn{display:flex;align-items:center;gap:0.6rem;width:100%;border:none;background:transparent;color:var(--text-muted);padding:0.65rem 1rem;cursor:pointer;font-size:0.85rem;font-family:var(--font-body);transition:all 0.15s;border-bottom:1px solid var(--border)}
.home-btn:hover{background:var(--surface-2);color:var(--text)}
.home-btn.active{background:var(--accent-dim);color:var(--accent);font-weight:600}
.main{padding:2rem 2rem 100px 2rem;overflow-y:auto}
.welcome{max-width:640px;margin:0 auto;animation:fadeUp 0.3s ease;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center}
.welcome-icon{font-size:2.5rem;margin-bottom:0.75rem}
.welcome h2{font-size:1.5rem;margin-bottom:0.5rem;letter-spacing:-0.5px}
.welcome>p{color:var(--text-muted);font-size:0.88rem;margin-bottom:2rem;line-height:1.6;max-width:520px}
.home-search{width:100%;max-width:620px;position:relative;margin-bottom:1.5rem}
.home-search-box{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:0.25rem;display:flex;align-items:center;box-shadow:0 2px 16px rgba(0,0,0,0.04);transition:border-color 0.2s,box-shadow 0.2s}
.home-search-box:focus-within{border-color:var(--accent);box-shadow:0 2px 24px rgba(37,99,235,0.1)}
.home-search-box input{flex:1;background:transparent;border:none;padding:0.85rem 1rem;color:var(--text);font-family:var(--font-body);font-size:0.95rem;outline:none;min-width:0}
.home-search-box input::placeholder{color:var(--text-muted)}
.home-search-actions{display:flex;align-items:center;gap:0.25rem;padding-right:0.35rem}
.home-search-actions button{border:none;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s;font-size:0.9rem;flex-shrink:0}
.home-search-actions .upload-home{background:transparent;color:var(--text-muted)}
.home-search-actions .upload-home:hover{background:var(--surface-2);color:var(--accent)}
.home-search-actions .search-send{background:var(--accent);color:#fff}
.home-search-actions .search-send:hover{filter:brightness(1.15);transform:scale(1.06)}
.home-hint{font-size:0.76rem;color:var(--text-muted);margin-top:0.5rem}
.mobile-quick{display:none;width:100%;max-width:560px}
@media(max-width:900px){.mobile-quick{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-top:1rem}}
.sb-quick{padding:0.5rem 0;border-bottom:1px solid var(--border)}
.sb-quick-btn{display:flex;align-items:center;gap:0.55rem;width:100%;border:none;background:transparent;color:var(--text);padding:0.5rem 1rem;cursor:pointer;font-size:0.82rem;font-family:var(--font-body);transition:all 0.15s;text-align:left;font-weight:500}
.sb-quick-btn:hover{background:var(--accent-dim);color:var(--accent)}
.sb-quick-btn .qicon{font-size:0.95rem;width:1.2rem;text-align:center}
.input-bar.hidden{display:none}
.brand-label{display:inline-block;padding:0.15rem 0.5rem;border-radius:5px;font-size:0.65rem;font-weight:700;font-family:var(--font-mono);letter-spacing:0.5px;vertical-align:middle;margin-right:0.3rem}
.brand-label.gp{background:var(--accent-dim);color:var(--accent)}
.brand-label.alk{background:var(--blue-dim);color:var(--blue)}
.quick-actions{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.7rem}
.quick-btn{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:0.8rem 1rem;cursor:pointer;display:flex;align-items:center;gap:0.6rem;color:var(--text);font-size:0.82rem;font-family:var(--font-body);transition:all 0.15s;text-align:left}
.quick-btn:hover{border-color:var(--accent);background:var(--accent-dim)}
.qicon{font-size:1rem}
.section-page{max-width:860px;margin:0 auto;animation:fadeUp 0.3s ease}
.back-btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:0.5rem 1rem;border-radius:10px;cursor:pointer;font-size:0.82rem;font-family:var(--font-body);font-weight:500;margin-bottom:1.25rem;transition:all 0.15s;display:inline-flex;align-items:center;gap:0.3rem}
.back-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.chat-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;gap:0.5rem}
.nav-btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:0.55rem 1.1rem;border-radius:10px;cursor:pointer;font-size:0.84rem;font-family:var(--font-body);font-weight:500;transition:all 0.15s;display:inline-flex;align-items:center;gap:0.4rem}
.nav-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.nav-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.nav-btn.primary:hover{background:#1d4ed8}
.page-header{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem}
.page-header-icon{font-size:2rem}
.page-header h2{font-size:1.3rem;letter-spacing:-0.4px}
.page-header p{color:var(--text-muted);font-size:0.82rem}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem}
.card h4{font-size:0.88rem;margin-bottom:0.7rem;color:var(--accent);font-weight:600}
.card h4.alk-h{color:var(--blue)}
.cause-item{padding:0.55rem 0;border-bottom:1px solid var(--border);font-size:0.83rem;line-height:1.6}
.cause-item:last-child{border-bottom:none}
.cause-item strong{display:block;margin-bottom:0.1rem}
.cause-item span{color:var(--success)}
.info-block{background:var(--surface-2);border-radius:10px;padding:0.8rem 1rem;margin:0.5rem 0;font-size:0.83rem;line-height:1.6}
.info-block p{margin-bottom:0.35rem}
.info-block p:last-child{margin-bottom:0}
.step-list{counter-reset:step;padding:0;list-style:none}
.step-item{display:flex;gap:0.7rem;padding:0.6rem 0;border-bottom:1px solid var(--border);font-size:0.85rem;line-height:1.55}
.step-item:last-child{border-bottom:none}
.step-num{width:26px;height:26px;border-radius:8px;background:var(--accent-dim);color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem;flex-shrink:0;font-family:var(--font-mono)}
.oil-result{background:var(--accent-dim);border:1px solid rgba(37,99,235,0.15);padding:0.8rem 1rem;border-radius:10px;margin:0.5rem 0;font-family:var(--font-mono);font-size:0.8rem}
.oil-result .model{color:var(--accent);font-weight:700}
.oil-badge{display:inline-block;padding:0.15rem 0.5rem;border-radius:6px;font-family:var(--font-mono);font-size:0.7rem;font-weight:700}
.oil-badge.s100{background:rgba(59,130,246,0.15);color:#60a5fa}
.oil-badge.s220{background:rgba(34,197,94,0.15);color:#4ade80}
.oil-badge.s8090{background:rgba(124,58,237,0.12);color:#7c3aed}
.data-table{width:100%;border-collapse:collapse;font-size:0.78rem;margin-top:0.5rem}
.data-table th{text-align:left;padding:0.5rem 0.6rem;background:var(--surface-3);color:var(--accent);font-size:0.68rem;text-transform:uppercase;letter-spacing:0.8px;border-bottom:2px solid var(--border);position:sticky;top:0}
.data-table td{padding:0.4rem 0.6rem;border-bottom:1px solid var(--border);color:var(--text-muted);font-family:var(--font-mono);font-size:0.76rem}
.data-table tr:hover td{color:var(--text);background:rgba(37,99,235,0.03)}
.data-table .model-cell{color:var(--accent);font-weight:700}
.series-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.7rem}
.series-card,.acc-cat-card{background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);padding:0.9rem;cursor:pointer;transition:all 0.15s}
.series-card:hover,.acc-cat-card:hover{border-color:var(--accent);background:var(--accent-dim)}
.series-card h5,.acc-cat-card h5{font-size:0.88rem;margin-bottom:0.3rem}
.series-card .sc-stats,.acc-cat-card span{font-size:0.72rem;color:var(--text-muted);font-family:var(--font-mono)}
.series-card .sc-range{font-size:0.7rem;color:var(--text-muted);margin-top:0.25rem}
.acc-cat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:0.7rem}
.filter-bar{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem}
.filter-bar input{background:var(--surface-2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:0.45rem 0.7rem;font-size:0.8rem;font-family:var(--font-body);outline:none}
.filter-bar input:focus{border-color:var(--accent)}
.result-count{font-size:0.73rem;color:var(--text-muted);margin-bottom:0.5rem;font-family:var(--font-mono)}
.tag{display:inline-block;padding:0.13rem 0.45rem;border-radius:5px;font-size:0.68rem;font-family:var(--font-mono);background:var(--surface-3);color:var(--text-muted);margin:0.1rem}
.msg{margin-bottom:1.5rem;animation:fadeUp 0.3s ease}
.msg-user{display:flex;justify-content:flex-end}
.msg-user .bubble{background:var(--accent);color:#fff;padding:0.65rem 1rem;border-radius:16px 16px 4px 16px;max-width:75%;font-weight:500;font-size:0.88rem}
.msg-bot{display:flex;gap:0.7rem;align-items:flex-start}
.bot-avatar{width:30px;height:30px;background:var(--surface-3);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;flex-shrink:0;margin-top:2px}
.msg-bot .bubble{background:var(--surface);border:1px solid var(--border);padding:0.9rem 1.15rem;border-radius:4px 16px 16px 16px;max-width:85%;font-size:0.88rem;line-height:1.65}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â”€â”€â”€ SAVED DIAGNOSTICS â”€â”€â”€ */
.save-btn{display:inline-flex;align-items:center;gap:0.35rem;background:none;border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.8rem;cursor:pointer;font-size:0.78rem;color:var(--text-muted);font-family:var(--font-body);margin-top:0.6rem;transition:all 0.15s}
.save-btn:hover{border-color:#16a34a;color:#16a34a;background:rgba(22,163,74,0.06)}
.save-btn.saved{border-color:#16a34a;color:#16a34a;cursor:default}
.save-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:none;align-items:center;justify-content:center;padding:1rem}
.save-modal-overlay.open{display:flex}
.save-modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;padding:1.5rem}
.save-modal h3{font-size:1.05rem;margin-bottom:1rem}
.save-field{margin-bottom:0.75rem}
.save-field label{display:block;font-size:0.72rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:0.25rem}
.save-field input,.save-field textarea,.save-field select{width:100%;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:0.55rem 0.75rem;color:var(--text);font-family:var(--font-body);font-size:0.85rem;outline:none}
.save-field input:focus,.save-field textarea:focus,.save-field select:focus{border-color:var(--accent)}
.save-field textarea{resize:vertical;min-height:70px}
.save-row{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
.save-actions{display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)}
.save-actions button{padding:0.5rem 1.2rem;border-radius:8px;border:1px solid var(--border);font-size:0.85rem;font-family:var(--font-body);cursor:pointer}
.save-actions .cancel-btn{background:transparent;color:var(--text-muted)}
.save-actions .confirm-btn{background:#16a34a;color:#fff;border-color:#16a34a;font-weight:600}
.save-actions .confirm-btn:hover{background:#15803d}
.diag-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1rem 1.25rem;cursor:pointer;transition:all 0.15s}
.diag-card:hover{border-color:var(--accent);background:var(--surface-2)}
.diag-card-header{display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem}
.diag-card h4{font-size:0.9rem;margin-bottom:0.25rem}
.diag-card .diag-meta{font-size:0.72rem;color:var(--text-muted);font-family:var(--font-mono)}
.diag-card .diag-category{display:inline-block;padding:0.1rem 0.5rem;border-radius:10px;font-size:0.68rem;font-weight:600;background:var(--accent-dim);color:var(--accent)}
.diag-card .diag-machine{font-size:0.78rem;color:var(--text-muted);margin-top:0.35rem}
.diag-card-actions{display:flex;gap:0.4rem;flex-shrink:0}
.diag-card-actions button{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.72rem;color:var(--text-muted);transition:0.15s}
.diag-card-actions .dl-btn:hover{border-color:var(--accent);color:var(--accent)}
.diag-card-actions .del-btn:hover{border-color:#ef4444;color:#ef4444}
.diag-list{display:flex;flex-direction:column;gap:0.75rem}
.diag-empty{text-align:center;padding:3rem 1rem;color:var(--text-muted)}
.diag-empty-icon{font-size:2.5rem;margin-bottom:0.75rem}
.diag-detail-header{display:flex;gap:1rem;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap}
.diag-detail-actions{display:flex;gap:0.5rem;margin-left:auto}
.sev-badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:0.7rem;font-weight:700;color:#fff}
.sev-critical{background:#dc2626}.sev-high{background:#ea580c}.sev-medium{background:#ca8a04}.sev-low{background:#16a34a}
@media(max-width:500px){.save-row{grid-template-columns:1fr}.save-modal{padding:1rem}}
#loginGate{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:99999;font-family:var(--font-body)}
#loginGate.hidden{display:none}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,0.08);padding:44px;width:380px;text-align:center}
.login-box::before{content:'';position:absolute;top:-150px;left:50%;transform:translateX(-50%);width:400px;height:300px;background:radial-gradient(ellipse,rgba(37,99,235,0.06) 0%,transparent 70%);pointer-events:none}
.login-logo-box{width:64px;height:64px;background:var(--accent);border-radius:14px;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-weight:700;font-size:0.9rem;color:#fff;margin:0 auto 20px}
.login-box h2{font-size:1.3rem;font-weight:700;color:var(--text);margin-bottom:6px;letter-spacing:-0.3px}
.login-box p{color:var(--text-muted);font-size:0.82rem;margin-bottom:28px}
.login-box input{width:100%;padding:12px 16px;background:var(--surface-2);border:1px solid var(--border);color:var(--text);border-radius:10px;font-size:16px;font-family:var(--font-body);outline:none;transition:border-color 0.2s;box-sizing:border-box;margin-bottom:14px}
.login-box input:focus{border-color:var(--accent)}
.login-box input::placeholder{color:var(--text-muted)}
.login-box button{width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:0.9rem;font-weight:700;font-family:var(--font-body);cursor:pointer;transition:all 0.15s}
.login-box button:hover{filter:brightness(1.15);transform:scale(1.02)}
.login-error{color:#f87171;font-size:0.78rem;margin-top:10px;display:none}
#appContent{display:none}
#appContent.visible{display:block;height:100vh;height:100dvh;overflow:hidden}

/* â•â•â• MOBILE ENHANCEMENTS â•â•â• */

/* iPhone notch / Dynamic Island safe areas */
@supports(padding:env(safe-area-inset-top)){
  header{padding-top:max(1rem,env(safe-area-inset-top));padding-left:max(2rem,env(safe-area-inset-left));padding-right:max(2rem,env(safe-area-inset-right))}
  .input-bar{padding-left:max(0.75rem,env(safe-area-inset-left));padding-right:max(0.75rem,env(safe-area-inset-right));padding-bottom:max(0.75rem,env(safe-area-inset-bottom))}
}

/* iOS momentum scrolling */
.main,.sidebar{-webkit-overflow-scrolling:touch;overscroll-behavior:contain}

/* Touch feedback on interactive elements */
.quick-btn:active{transform:scale(0.97);opacity:0.85}
.topic-btn:active{background:var(--surface-3);transform:scale(0.98)}
.nav-btn:active{transform:scale(0.97)}
.send-btn:active{transform:scale(0.94)}
.back-btn:active{transform:scale(0.97)}
.upload-btn:active{transform:scale(0.97)}

/* Prevent tap highlight flash on iOS */
.quick-btn,.topic-btn,.nav-btn,.send-btn,.back-btn,.upload-btn,.home-btn,.hamburger,.logout-btn,.series-card,.acc-cat-card{
  -webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}

/* Touch target minimums (44px per Apple/Google guidelines) */
.topic-btn{min-height:44px}
.home-btn{min-height:44px}
.quick-btn{min-height:44px}

/* Small phones (â‰¤400px, iPhone SE) */
@media(max-width:400px){
  header{padding:0.6rem 0.75rem;gap:0.5rem}
  .logo{width:36px;height:36px;font-size:0.6rem;border-radius:8px}
  .header-text h1{font-size:0.9rem}
  .header-text span{font-size:0.65rem}
  .input-bar{padding:0.5rem 0.6rem}
  .quick-actions{grid-template-columns:1fr}
  .mobile-quick{grid-template-columns:1fr}
  .welcome h2{font-size:1.2rem}
  .welcome>p{font-size:0.82rem}
  .home-search{flex-wrap:wrap}
  .home-search input{min-width:0}
  .msg-user .bubble{max-width:85%}
  .msg-bot .bubble{max-width:92%}
  .login-box{width:calc(100vw - 2rem);padding:28px 24px}
}

/* Landscape phones */
@media(max-height:500px) and (orientation:landscape){
  header{padding:0.4rem 1rem}
  .input-bar{padding:0.4rem 1rem}
  .logo{width:32px;height:32px}
}
</style>
</head>
<body>
<!-- Login Gate -->
<div id="loginGate">
  <div class="login-box">
    <div class="login-logo-box">P-S</div>
    <h2>P-Supp Tool</h2>
    <p>Internal Access Only</p>
    <input type="password" id="loginPass" placeholder="Enter team password" autocomplete="off" />
    <button onclick="tryLogin()">Sign In</button>
    <div class="login-error" id="loginError">Incorrect password. Try again.</div>
  </div>
</div>
<script>
const TEAM_PASSWORD = "psupp2025"; // â† CHANGE THIS
function tryLogin(){const i=document.getElementById('loginPass'),e=document.getElementById('loginError');if(i.value===TEAM_PASSWORD){sessionStorage.setItem('authenticated','true');unlockApp();}else{e.style.display='block';i.value='';i.focus();}}
function unlockApp(){document.getElementById('loginGate').classList.add('hidden');document.getElementById('appContent').classList.add('visible');}
document.getElementById('loginPass').addEventListener('keydown',function(e){if(e.key==='Enter')tryLogin();});
</script>

<div id="appContent">
<div class="app">
  <header>
    <div class="logo" onclick="exitChat?exitChat():showHome()" style="cursor:pointer" title="Home">P-S</div>
    <div class="header-text" onclick="exitChat?exitChat():showHome()" style="cursor:pointer"><h1>P-Supp Tool</h1><span>Diagnostics, Service &amp; Reference</span></div>
    <div class="header-right">
      <div style="position:relative">
        <button class="hamburger" onclick="document.getElementById('hamMenu').classList.toggle('open')" title="Stats">
          <span></span><span></span><span></span>
        </button>
        <div class="ham-menu" id="hamMenu">
          <div class="header-stats" id="headerStats"></div>
        </div>
      </div>
      <button class="logout-btn" onclick="sessionStorage.removeItem('authenticated');location.reload();">Logout</button>
    </div>
  </header>
  <div class="input-bar hidden">
    <div id="imgPreviewBar" class="img-preview-bar" style="display:none"><img id="imgThumb"/><span id="imgName"></span><button class="remove-img" onclick="clearImage()" title="Remove">âœ•</button></div>
    <div class="input-wrap">
    <input type="file" id="imageUpload" accept="image/*" style="display:none" onchange="handleImageSelect(event)"/>
    <button class="upload-btn" onclick="document.getElementById('imageUpload').click()" title="Upload photo">ğŸ“· <span class="btn-label">Photo</span></button>
    <input type="text" id="userInput" placeholder="Search models, troubleshoot issues, look up specsâ€¦" autocomplete="off"/>
    <button class="send-btn" onclick="handleSend()" title="Send"><span class="btn-label">Send</span> â¤</button>
  </div></div>
  <div class="layout">
    <nav class="sidebar" id="sidebar"></nav>
    <div class="main"><div class="content-area" id="contentArea"></div></div>
  </div>
</div>
<script src="knowledge-base.js"></script>
<script>
const C=document.getElementById('contentArea'),I=document.getElementById('userInput'),SB=document.getElementById('sidebar');
const MAIN=C.parentElement; // .main is the scrollable container
function scrollToMsg(el){if(el)el.scrollIntoView({behavior:"smooth",block:"start"});}
function scrollBottom(){MAIN.scrollTop=MAIN.scrollHeight;}
if(sessionStorage.getItem('authenticated')==='true')unlockApp();
window.addEventListener('popstate',function(e){if(inChat){exitChat();}});

/* â•â•â• IMAGE UPLOAD â•â•â• */
let pendingImage=null;
function handleImageSelect(e){
  const file=e.target.files[0];if(!file)return;
  if(file.size>20*1024*1024){alert('Image too large. Max 20MB.');return;}
  const reader=new FileReader();
  reader.onload=function(ev){
    pendingImage={data:ev.target.result.split(',')[1], mediaType:file.type, name:file.name};
    document.getElementById('imgThumb').src=ev.target.result;
    document.getElementById('imgName').textContent=file.name;
    document.getElementById('imgPreviewBar').style.display='flex';
    I.placeholder='Describe the issue or ask about this equipment...';
    I.focus();
  };
  reader.readAsDataURL(file);
}
function clearImage(){
  pendingImage=null;
  document.getElementById('imgPreviewBar').style.display='none';
  document.getElementById('imageUpload').value='';
  I.placeholder='Search models, troubleshoot issues, look up specsâ€¦';
}
const esc=t=>{const d=document.createElement('div');d.textContent=t;return d.innerHTML};
const norm=s=>s.toLowerCase().replace(/[^a-z0-9 ]/g,' ').replace(/\s+/g,' ').trim();
let _rcId=0;
const renderCauses=(c,limit)=>{
  const lim=typeof limit==='number'?limit:c.length;
  const show=c.slice(0,lim);
  const rest=c.slice(lim);
  let html=show.map(x=>`<div class="cause-item"><strong>âš  ${x.cause}</strong><span>âœ“ ${x.remedy}</span></div>`).join('');
  if(rest.length>0){
    _rcId++;
    html+=`<button class="show-more-btn" onclick="this.style.display='none';document.getElementById('rc${_rcId}').style.display='block'" style="background:none;border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.8rem;cursor:pointer;font-size:0.78rem;color:var(--accent);font-family:var(--font-body);margin-top:0.5rem">Show ${rest.length} more â–¾</button>`;
    html+=`<div id="rc${_rcId}" style="display:none">${rest.map(x=>`<div class="cause-item"><strong>âš  ${x.cause}</strong><span>âœ“ ${x.remedy}</span></div>`).join('')}</div>`;
  }
  return html;
};
const renderSteps=s=>`<ol class="step-list">${s.map((x,i)=>`<li class="step-item"><div class="step-num">${i+1}</div><div>${x}</div></li>`).join('')}</ol>`;

function buildSidebar(){
  let h=`<button class="home-btn active" data-topic="home" onclick="nav('home')"><span class="topic-icon">ğŸ </span> Home</button>`;
  h+=`<button class="home-btn" data-topic="saved-diags" onclick="showSavedDiags()"><span class="topic-icon">ğŸ“‹</span> My Diagnostics</button>`;
  h+=`<div class="sb-quick">`;
  [['pressure','ğŸ“‰','Low pressure'],['oil','ğŸ›¢ï¸','Oil lookup'],['burner','ğŸ”¥','Burner issues'],['service','âš™ï¸','Service & repair'],['chemical','ğŸ§ª','Chemical issues'],['electrical','âš¡','Electrical'],['find','ğŸ”','Find a pump'],['pilot','ğŸ”¥','Pilot light'],['maintenance','ğŸ—“ï¸','Maintenance']].forEach(([t,ic,lb])=>h+=`<button class="sb-quick-btn" onclick="startTopic('${t}')"><span class="qicon">${ic}</span>${lb}</button>`);
  h+=`</div>`;

  SB.innerHTML=h;
  document.querySelectorAll('.sb-body').forEach(b=>{b.style.maxHeight=b.scrollHeight+'px'});
}

function toggleSection(id){const el=document.getElementById(id);el.classList.toggle('collapsed');if(!el.classList.contains('collapsed')){const body=el.querySelector('.sb-body');body.style.maxHeight=body.scrollHeight+'px';}}
function setActive(t){document.querySelectorAll('.topic-btn,.home-btn').forEach(b=>b.classList.remove('active','alk-active'));const btn=document.querySelector(`[data-topic="${t}"]`);if(btn){btn.classList.add('active');if(t.startsWith('alk-'))btn.classList.add('alk-active');}}
function getSeriesGroups(){const g={};for(const m of KB.gp.pumpModels){const s=m[6];if(!g[s])g[s]={models:[],minGPM:Infinity,maxGPM:0,minPSI:Infinity,maxPSI:0};g[s].models.push(m);const gpm=parseFloat(m[1]),psi=parseInt(m[2]);if(gpm<g[s].minGPM)g[s].minGPM=gpm;if(gpm>g[s].maxGPM)g[s].maxGPM=gpm;if(psi<g[s].minPSI)g[s].minPSI=psi;if(psi>g[s].maxPSI)g[s].maxPSI=psi;}return g;}
function findOil(q){q=norm(q);const r=[];for(const[,s]of Object.entries(KB.gp.oilRecommendations)){for(const p of s.pumps){const pn=norm(p);if(q.includes(pn)||pn.includes(q.replace(/\s/g,'')))r.push({model:p,oil:s.label,weight:s.weight,badge:s.badge});}}return[...new Map(r.map(x=>[x.model,x])).values()];}

/* â•â•â• PAGES â•â•â• */
function showHome(){setActive('home');inChat=false;document.querySelector('.input-bar').classList.add('hidden');C.innerHTML=`<div class="welcome"><div class="welcome-icon">ğŸ”§</div><h2>How can I help?</h2><p>Search across ${KB.gp.pumpModels.length} pump models, troubleshooting, oil &amp; service data, and equipment manuals.</p><div class="home-search"><div class="home-search-box"><input type="text" id="homeInput" placeholder="Describe your issue or search modelsâ€¦" autocomplete="off"/><div class="home-search-actions"><button class="upload-home" onclick="document.getElementById('imageUpload').click()" title="Upload photo">ğŸ“·</button><button class="search-send" onclick="homeSearch()" title="Send">â¤</button></div></div></div><p class="home-hint">Try: "pump losing pressure" Â· "oil for TS2021" Â· "burner won't fire"</p><div class="mobile-quick"><button class="quick-btn" onclick="startTopic('pressure')"><span class="qicon">ğŸ“‰</span> Low pressure</button><button class="quick-btn" onclick="startTopic('oil')"><span class="qicon">ğŸ›¢ï¸</span> Oil lookup</button><button class="quick-btn" onclick="startTopic('burner')"><span class="qicon">ğŸ”¥</span> Burner issues</button><button class="quick-btn" onclick="startTopic('service')"><span class="qicon">âš™ï¸</span> Service &amp; repair</button><button class="quick-btn" onclick="startTopic('chemical')"><span class="qicon">ğŸ§ª</span> Soap / Chemical</button><button class="quick-btn" onclick="startTopic('electrical')"><span class="qicon">âš¡</span> Electrical</button><button class="quick-btn" onclick="startTopic('find')"><span class="qicon">ğŸ”</span> Find a pump</button><button class="quick-btn" onclick="startTopic('maintenance')"><span class="qicon">ğŸ—“ï¸</span> Maintenance</button><button class="quick-btn" onclick="showSavedDiags()"><span class="qicon">ğŸ“‹</span> My Diagnostics</button></div><div class="mobile-quick" style="margin-top:0.5rem"><button class="quick-btn" onclick="startTopic('nozzle')" style="border-color:rgba(37,99,235,0.3);background:rgba(37,99,235,0.04)"><span class="qicon">ğŸ¯</span> Nozzle Calculator</button><button class="quick-btn" onclick="startTopic('injector')" style="border-color:rgba(37,99,235,0.3);background:rgba(37,99,235,0.04)"><span class="qicon">ğŸ’‰</span> Injector Sizing</button><button class="quick-btn" onclick="startTopic('multimeter')" style="border-color:rgba(37,99,235,0.3);background:rgba(37,99,235,0.04)"><span class="qicon">âš¡</span> Multimeter Assistant</button></div></div>`;document.getElementById('homeInput').addEventListener('keydown',e=>{if(e.key==='Enter')homeSearch()});document.getElementById('homeInput').focus();}

function showGPTrouble(key){const t=KB.gp.troubleshooting[key];if(!t)return;setActive('gp-'+key);let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">${t.icon}</div><div><h2>${t.title}</h2><p>${t.desc||''}</p></div></div>`;if(t.causes)h+=`<div class="card"><h4>Possible Causes &amp; Remedies</h4>${renderCauses(t.causes)}</div>`;if(t.items)for(const i of t.items)h+=`<div class="card"><h4>${i.subtitle}</h4>${renderCauses(i.causes)}</div>`;h+=`</div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showGPService(key){const s=KB.gp.serviceProcedures[key];if(!s)return;setActive('gp-'+key);let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">${s.icon}</div><div><h2>${s.title}</h2><p>${s.desc}</p></div></div><div class="card"><h4>Procedure</h4>${renderSteps(s.steps)}</div>`;if(s.notes)h+=`<div class="card"><h4>Notes</h4><div class="info-block"><p>${s.notes}</p></div></div>`;h+=`</div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showGPOil(){setActive('gp-oil');C.innerHTML=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ›¢ï¸</div><div><h2>Oil &amp; Lubrication</h2><p></p></div></div><div class="card"><h4>Oil Change Schedule</h4><div class="info-block"><p>${KB.gp.maintenance.oilChange}</p></div></div><div class="card"><h4>Three Oil Series</h4><div class="info-block"><p><span class="oil-badge s100">SERIES 100</span>&nbsp; 30W Non-Detergent â€” T, TS, TC, TX, TT, EZ, HTC, HTF, HTS, EP, ET, ES, TP series.</p></div><div class="info-block"><p><span class="oil-badge s220">SERIES 220</span>&nbsp; 50W â€” HF, KE, KF, KFMB, KFMZ, KS, LK, MK, MW, SK, VF, VK series.</p></div><div class="info-block"><p><span class="oil-badge s8090">SERIES 8090</span>&nbsp; 80/90 Gear Lube â€” T41â€“T151, T1551â€“T4251, CW, YGR/ZGRS gear reducers.</p></div></div><div class="card"><h4>Look Up Your Model</h4><p style="font-size:0.83rem;color:var(--text-muted)">Type your pump model in the search bar for a specific recommendation.</p></div></div>`;MAIN.scrollTop=0;}

function showGPMaint(){setActive('gp-maintenance');C.innerHTML=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ—“ï¸</div><div><h2>Maintenance Schedule</h2><p></p></div></div><div class="card"><h4>Oil Changes</h4><div class="info-block"><p>${KB.gp.maintenance.oilChange}</p></div></div><div class="card"><h4>Every 500 Hours</h4>${renderSteps(KB.gp.maintenance.every500)}</div><div class="card"><h4>Every 1,000 Hours</h4>${renderSteps(KB.gp.maintenance.every1000)}</div><div class="card"><h4>Start-Up Checklist</h4>${renderSteps(KB.gp.maintenance.startup)}</div><div class="card"><h4>Additional Tips</h4><div class="info-block"><p>ğŸ’§ <strong>Daily Flushing:</strong> ${KB.gp.maintenance.flushing}</p></div><div class="info-block"><p>â„ï¸ <strong>Freeze Protection:</strong> ${KB.gp.maintenance.freezing}</p></div></div></div>`;MAIN.scrollTop=0;}

function showGPSystem(){setActive('gp-system');let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ“‹</div><div><h2>System Design</h2><p></p></div></div>`;for(const i of Object.values(KB.gp.systemDesign))h+=`<div class="card"><h4>${i.title}</h4><div class="info-block"><p>${i.text}</p></div></div>`;h+=`</div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showGPWarranty(){setActive('gp-warranty');const w=KB.gp.warranty;C.innerHTML=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ“„</div><div><h2>Warranty</h2><p></p></div></div><div class="card"><h4>Pump â€” 5 Years</h4><div class="info-block"><p>${w.pumpWarranty}</p></div></div><div class="card"><h4>Manifold â€” Lifetime</h4><div class="info-block"><p>${w.manifoldWarranty}</p></div></div><div class="card"><h4>Consumer â€” 2 Years</h4><div class="info-block"><p>${w.consumerWarranty}</p></div></div><div class="card"><h4>Accessories â€” 1 Year</h4><div class="info-block"><p>${w.accessoryWarranty}</p></div></div><div class="card"><h4>Not Covered</h4>${w.notCovered.map(x=>`<div class="cause-item"><strong>âœ— ${x}</strong></div>`).join('')}</div><div class="card"><h4>Wear Parts</h4><div class="info-block"><p>${w.wearParts.map(x=>`<span class="tag">${x}</span>`).join(' ')}</p></div></div></div>`;MAIN.scrollTop=0;}

function showGPCatalog(){setActive('gp-catalog');const g=getSeriesGroups();const sorted=Object.entries(g).sort((a,b)=>b[1].models.length-a[1].models.length);let cards=sorted.map(([n,d])=>`<div class="series-card" onclick="showSeriesDetail('${esc(n)}')"><h5>${n}</h5><div class="sc-stats">${d.models.length} models</div><div class="sc-range">${d.minGPM}â€“${d.maxGPM} GPM Â· ${d.minPSI.toLocaleString()}â€“${d.maxPSI.toLocaleString()} PSI</div></div>`).join('');C.innerHTML=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ“–</div><div><h2>Product Catalog</h2><p>${KB.gp.pumpModels.length} models Â· ${sorted.length} series</p></div></div><div class="card"><h4>Browse by Series</h4><div class="series-grid">${cards}</div></div><div class="card"><h4>Search All Models</h4><div class="filter-bar"><input type="text" id="catSearch" placeholder="Model numberâ€¦" oninput="filterCat()"/><input type="number" id="catMinGPM" placeholder="Min GPM" style="width:85px" oninput="filterCat()"/><input type="number" id="catMaxGPM" placeholder="Max GPM" style="width:85px" oninput="filterCat()"/><input type="number" id="catMinPSI" placeholder="Min PSI" style="width:85px" oninput="filterCat()"/><input type="number" id="catMaxPSI" placeholder="Max PSI" style="width:85px" oninput="filterCat()"/></div><div class="result-count" id="catCount"></div><div style="max-height:400px;overflow-y:auto"><table class="data-table"><thead><tr><th>Model</th><th>GPM</th><th>PSI</th><th>RPM</th><th>HP</th><th>Wt</th><th>Series</th></tr></thead><tbody id="catBody"></tbody></table></div></div></div>`;filterCat();MAIN.scrollTop=0;}

function filterCat(){const q=norm(document.getElementById('catSearch')?.value||'');const minG=parseFloat(document.getElementById('catMinGPM')?.value)||0;const maxG=parseFloat(document.getElementById('catMaxGPM')?.value)||99999;const minP=parseInt(document.getElementById('catMinPSI')?.value)||0;const maxP=parseInt(document.getElementById('catMaxPSI')?.value)||999999;let r=KB.gp.pumpModels.filter(m=>{const g=parseFloat(m[1]),p=parseInt(m[2]);if(g<minG||g>maxG||p<minP||p>maxP)return false;if(q&&!norm(m[0]).includes(q)&&!norm(m[6]).includes(q))return false;return true;});const show=r.slice(0,100);document.getElementById('catCount').textContent=`${r.length} models${r.length>100?' (first 100)':''}`;document.getElementById('catBody').innerHTML=show.map(m=>`<tr><td class="model-cell">${m[0]}</td><td>${m[1]}</td><td>${parseInt(m[2]).toLocaleString()}</td><td>${m[3]}</td><td>${m[4]}</td><td>${m[5]}</td><td>${m[6]}</td></tr>`).join('');}

function showSeriesDetail(name){const g=getSeriesGroups();const d=g[name];if(!d)return;let rows=d.models.map(m=>`<tr><td class="model-cell">${m[0]}</td><td>${m[1]}</td><td>${parseInt(m[2]).toLocaleString()}</td><td>${m[3]}</td><td>${m[4]}</td><td>${m[5]}</td></tr>`).join('');C.innerHTML=`<div class="section-page"><button class="back-btn" onclick="showGPCatalog()">â† Back to Catalog</button><div class="page-header"><div class="page-header-icon">ğŸ“–</div><div><h2>${name}</h2><p>${d.models.length} models Â· ${d.minGPM}â€“${d.maxGPM} GPM Â· ${d.minPSI.toLocaleString()}â€“${d.maxPSI.toLocaleString()} PSI</p></div></div><div class="card"><div style="max-height:500px;overflow-y:auto"><table class="data-table"><thead><tr><th>Model</th><th>GPM</th><th>PSI</th><th>RPM</th><th>HP</th><th>Wt</th></tr></thead><tbody>${rows}</tbody></table></div></div></div>`;MAIN.scrollTop=0;}

function showGPAccessories(){setActive('gp-accessories');const cats=Object.entries(KB.gp.accessories);let cards=cats.map(([n,items])=>`<div class="acc-cat-card" onclick="showAccDetail('${esc(n)}')"><h5>${n}</h5><span>${items.length} items</span></div>`).join('');C.innerHTML=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ”—</div><div><h2>Accessories</h2><p>${cats.reduce((a,c)=>a+c[1].length,0)} items Â· ${cats.length} categories</p></div></div><div class="card"><h4>Browse by Category</h4><div class="acc-cat-grid">${cards}</div></div></div>`;MAIN.scrollTop=0;}

function showAccDetail(name){const items=KB.gp.accessories[name];if(!items)return;let rows=items.map(x=>`<tr><td class="model-cell">${x[0]}</td><td style="font-family:var(--font-body);color:var(--text-muted)">${x[1]}</td></tr>`).join('');C.innerHTML=`<div class="section-page"><button class="back-btn" onclick="showGPAccessories()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ”—</div><div><h2>${name}</h2><p>${items.length} items</p></div></div><div class="card"><div style="max-height:600px;overflow-y:auto"><table class="data-table"><thead><tr><th>Part Number</th><th>Description</th></tr></thead><tbody>${rows}</tbody></table></div></div></div>`;MAIN.scrollTop=0;}

function showAlkTrouble(key){const t=KB.alk.troubleshooting[key];if(!t)return;setActive('alk-ts-'+key);C.innerHTML=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">${t.icon}</div><div><h2>${t.title}</h2><p>${t.causes.length} cause/remedy pairs</p></div></div><div class="card"><h4 class="alk-h">Possible Causes &amp; Remedies</h4>${renderCauses(t.causes)}</div></div>`;MAIN.scrollTop=0;}

function showAlkMaint(){setActive('alk-maintenance');const m=KB.alk.maintenance;let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ—“ï¸</div><div><h2>Maintenance</h2><p></p></div></div>`;for(const[key,val]of Object.entries(m.general)){const title=key.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();h+=`<div class="card"><h4 class="alk-h">${title}</h4><div class="info-block"><p>${val}</p></div></div>`;}h+=`</div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showAlkInstall(){setActive('alk-installation');const inst=KB.alk.installation;let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ—ï¸</div><div><h2>Installation Guide</h2><p></p></div></div>`;for(const[key,val]of Object.entries(inst)){const title=key.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();h+=`<div class="card"><h4 class="alk-h">${title}</h4><div class="info-block"><p>${val}</p></div></div>`;}h+=`</div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showAlkStartup(){setActive('alk-startup');const m=KB.alk.maintenance;C.innerHTML=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">â–¶ï¸</div><div><h2>Start-Up &amp; Shutdown</h2><p></p></div></div><div class="card"><h4 class="alk-h">Start-Up Procedure</h4>${renderSteps(m.startup)}</div><div class="card"><h4 class="alk-h">Shutdown Procedure</h4>${renderSteps(m.shutdown)}</div></div>`;MAIN.scrollTop=0;}

function showAlkPumpSvc(){setActive('alk-pump-svc');const p=KB.alk.serviceSchool.pumpService;let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ”§</div><div><h2>Pump Service</h2><p></p></div></div>`;h+=`<div class="card"><h4 class="alk-h">âš ï¸ Key Facts</h4><div class="info-block"><p><strong>Max Water Temp:</strong> ${p.maxTemp}</p></div><div class="info-block"><p><strong>Cavitation:</strong> ${p.cavitation}</p></div><div class="info-block"><p><strong>Plunger Cracking:</strong> ${p.plungerCracking}</p></div><div class="info-block"><p><strong>Pump Oil:</strong> ${p.pumpOil}</p></div></div>`;h+=`<div class="card"><h4 class="alk-h">Pump Head Removal &amp; Reassembly</h4>${renderSteps(p.headRemoval)}</div>`;h+=`<div class="card"><h4 class="alk-h">Check Valves</h4><div class="info-block"><p>${p.checkValves}</p></div></div>`;h+=`<div class="card"><h4 class="alk-h">V-Packings</h4><div class="info-block"><p>${p.vPackings}</p></div></div>`;h+=`<div class="card"><h4 class="alk-h">Tools</h4><div class="info-block"><p>${p.tools}</p></div></div>`;
const pt=KB.alk.serviceSchool.pumpTroubleshooting;h+=`<div class="card"><h4 class="alk-h">Pump Troubleshooting</h4>`;for(const[prob,causes]of Object.entries(pt)){h+=`<div style="margin:0.7rem 0"><strong style="color:var(--blue)">${prob}</strong>${renderCauses(causes)}</div>`;}h+=`</div></div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showAlkUnloaders(){setActive('alk-unloaders');const u=KB.alk.serviceSchool.unloaders;let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">âš™ï¸</div><div><h2>Unloaders &amp; Accessories</h2><p></p></div></div>`;for(const[key,val]of Object.entries(u)){const t=key.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();h+=`<div class="card"><h4 class="alk-h">${t}</h4><div class="info-block"><p>${val}</p></div></div>`;}
const ut=KB.alk.serviceSchool.unloaderTroubleshooting;h+=`<div class="card"><h4 class="alk-h">Unloader Troubleshooting</h4>`;for(const[prob,causes]of Object.entries(ut)){h+=`<div style="margin:0.7rem 0"><strong style="color:var(--blue)">${prob}</strong>${renderCauses(causes)}</div>`;}h+=`</div></div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showAlkElectrical(){setActive('alk-electrical');const e=KB.alk.serviceSchool.electrical;let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">âš¡</div><div><h2>Electrical Components</h2><p></p></div></div>`;for(const[key,val]of Object.entries(e)){const t=key.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();h+=`<div class="card"><h4 class="alk-h">${t}</h4><div class="info-block"><p>${val}</p></div></div>`;}h+=`</div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showAlkCoils(){setActive('alk-coils');const c=KB.alk.serviceSchool.coils;let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ”¥</div><div><h2>Coils &amp; Heat Exchangers</h2><p></p></div></div>`;for(const[key,val]of Object.entries(c)){const t=key.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();h+=`<div class="card"><h4 class="alk-h">${t}</h4><div class="info-block"><p>${val}</p></div></div>`;}h+=`</div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showAlkBurnerRef(){setActive('alk-burner-ref');const b=KB.alk.serviceSchool.burners;let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ”¥</div><div><h2>Burner Reference</h2><p></p></div></div>`;for(const[key,val]of Object.entries(b)){const t=key.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();h+=`<div class="card"><h4 class="alk-h">${t}</h4><div class="info-block"><p>${val}</p></div></div>`;}
const obt=KB.alk.serviceSchool.oilBurnerTroubleshooting;h+=`<div class="card"><h4 class="alk-h">Oil Burner Troubleshooting</h4>`;for(const[prob,causes]of Object.entries(obt)){h+=`<div style="margin:0.7rem 0"><strong style="color:var(--blue)">${prob}</strong>${renderCauses(causes)}</div>`;}h+=`</div>`;
const ght=KB.alk.serviceSchool.gasHeaterTroubleshooting;h+=`<div class="card"><h4 class="alk-h">Gas Heater Troubleshooting</h4>`;for(const[prob,causes]of Object.entries(ght)){h+=`<div style="margin:0.7rem 0"><strong style="color:var(--blue)">${prob}</strong>${renderCauses(causes)}</div>`;}h+=`</div></div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showAlkNozzles(){setActive('alk-nozzles');const n=KB.alk.serviceSchool.nozzles;let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ’¨</div><div><h2>Spray Nozzles</h2><p></p></div></div>`;for(const[key,val]of Object.entries(n)){const t=key.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();h+=`<div class="card"><h4 class="alk-h">${t}</h4><div class="info-block"><p>${val}</p></div></div>`;}h+=`</div>`;C.innerHTML=h;MAIN.scrollTop=0;}

function showAlkChecklist(){setActive('alk-checklist');C.innerHTML=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">âœ…</div><div><h2>Pre-Service Checklist</h2><p></p></div></div><div class="card"><h4 class="alk-h">Complete Pre-Service Inspection</h4>${renderSteps(KB.alk.serviceSchool.preServiceChecklist)}</div></div>`;MAIN.scrollTop=0;}

function showAlkWarranty(){setActive('alk-warranty');const w=KB.alk.serviceSchool.warranty;let h=`<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ“„</div><div><h2>Warranty</h2><p></p></div></div>`;for(const[key,val]of Object.entries(w)){const t=key.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();h+=`<div class="card"><h4 class="alk-h">${t}</h4><div class="info-block"><p>${val}</p></div></div>`;}h+=`</div>`;C.innerHTML=h;MAIN.scrollTop=0;}

/* â•â•â• SEARCH â•â•â• */
function genResponse(query){const q=norm(query);let html='';let found=false;
  const pr=KB.gp.pumpModels.filter(m=>{const mn=norm(m[0]);return mn===q||q.includes(mn)||mn.includes(q);});
  if(pr.length>0&&pr.length<=20){html+=`<h4>Pump Specifications</h4><table class="data-table"><thead><tr><th>Model</th><th>GPM</th><th>PSI</th><th>RPM</th><th>HP</th><th>Wt</th><th>Series</th></tr></thead><tbody>`;for(const m of pr)html+=`<tr><td class="model-cell">${m[0]}</td><td>${m[1]}</td><td>${parseInt(m[2]).toLocaleString()}</td><td>${m[3]}</td><td>${m[4]}</td><td>${m[5]}</td><td>${m[6]}</td></tr>`;html+=`</tbody></table>`;found=true;}
  const oilR=findOil(query);if(oilR.length>0){html+=`<h4>Oil Recommendation</h4>`;for(const r of oilR)html+=`<div class="oil-result"><span class="model">${r.model}</span> â†’ <span class="oil-badge ${r.badge}">${r.oil}</span> (${r.weight})</div>`;html+=`<div class="info-block"><p>â±ï¸ ${KB.gp.maintenance.oilChange}</p></div>`;found=true;}else if(/oil|lubric|lube|what oil|which oil/.test(q)){html+=`<h4>Oil</h4><div class="info-block"><p><span class="oil-badge s100">100</span> 30W Â· <span class="oil-badge s220">220</span> 50W Â· <span class="oil-badge s8090">8090</span> 80/90 Gear Lube â€” provide model for specific rec.</p></div>`;found=true;}
  const gpmM=q.match(/(\d+\.?\d*)\s*gpm/),psiM=q.match(/(\d+)\s*psi/);if((gpmM||psiM)&&/find|need|looking|want|recommend|which|what pump|select/.test(q)){const tG=gpmM?parseFloat(gpmM[1]):null,tP=psiM?parseInt(psiM[1]):null;let r=KB.gp.pumpModels.filter(m=>{const g=parseFloat(m[1]),p=parseInt(m[2]);if(tG&&(g<tG*0.85||g>tG*1.3))return false;if(tP&&(p<tP*0.85||p>tP*1.15))return false;return true;}).slice(0,15);if(r.length>0){html+=`<h4>Matching Pumps</h4><table class="data-table"><thead><tr><th>Model</th><th>GPM</th><th>PSI</th><th>RPM</th><th>HP</th><th>Series</th></tr></thead><tbody>`;for(const m of r)html+=`<tr><td class="model-cell">${m[0]}</td><td>${m[1]}</td><td>${parseInt(m[2]).toLocaleString()}</td><td>${m[3]}</td><td>${m[4]}</td><td>${m[6]}</td></tr>`;html+=`</tbody></table>`;found=true;}}
  if(/how (do|to)|service|replace|repair|remove|install|fix|rebuild|steps|procedure/.test(q)){const procs=[];if(/valve/.test(q))procs.push(KB.gp.serviceProcedures.valves);if(/plunger/.test(q))procs.push(KB.gp.serviceProcedures.plungers);if(/v.?pack|packing|seal replace/.test(q))procs.push(KB.gp.serviceProcedures.vpackings);if(procs.length>0){for(const p of procs){html+=`<h4>${p.title}</h4>${renderSteps(p.steps)}`;if(p.notes)html+=`<div class="info-block"><p>ğŸ“Œ ${p.notes}</p></div>`;}found=true;}}
  const gpKW={pressure:["low pressure","no pressure","pressure drop","losing pressure"],pulsation:["pulsation","pulse","pulsing","surging"],rough:["rough","very low","cavitation","no output"],noise:["knock","knocking","loud noise","banging","noise","rattle"],packing:["packing failure","packing wear","premature packing"],overheating:["overheat","overheating","pump hot","running hot"],leak:["leak","leaking","drip","water leak","oil leak","milky oil","water in crankcase"]};
  // Only show the BEST matching troubleshooting category, not all
  let bestGP=null,bestGPScore=0;
  for(const[k,kws]of Object.entries(gpKW)){let score=0;for(const kw of kws){if(q.includes(kw))score+=kw.includes(' ')?3:1;}if(score>bestGPScore){bestGPScore=score;bestGP=k;}}
  if(bestGP&&!found){const t=KB.gp.troubleshooting[bestGP];if(t){html+=`<h4>${t.icon} ${t.title}</h4>`;const causes=t.causes||(t.items?t.items.flatMap(i=>i.causes):[]);html+=renderCauses(causes,3);found=true;}}
  // Only check Alkota troubleshooting if no GP match found
  if(!found){let bestAlk=null,bestAlkScore=0;for(const[key,val]of Object.entries(KB.alk.troubleshooting)){let score=0;const tw=norm(val.title).split(' ');for(const w of tw){if(w.length>3&&q.includes(w))score+=1;}for(const c of val.causes){for(const w of norm(c.cause).split(' ')){if(w.length>4&&q.includes(w))score+=1;}}if(score>bestAlkScore){bestAlkScore=score;bestAlk=key;}}if(bestAlk){const val=KB.alk.troubleshooting[bestAlk];html+=`<h4>${val.icon} ${val.title}</h4>${renderCauses(val.causes.slice(0,10),3)}`;found=true;}}
  if(/maintenance|schedule|interval|when should|how often/.test(q)&&!found){html+=`<h4>Maintenance</h4><div class="info-block"><p>${KB.gp.maintenance.oilChange}</p><p><strong>Every 500h:</strong> ${KB.gp.maintenance.every500.join(', ')}</p></div><h4 style="margin-top:1rem">Maintenance</h4>`;for(const[k,v]of Object.entries(KB.alk.maintenance.general).slice(0,4))html+=`<div class="info-block"><p><strong>${k.replace(/([A-Z])/g,' $1').trim()}:</strong> ${v}</p></div>`;found=true;}
  // Service school search
  if(KB.alk.serviceSchool&&!found){const ssts=[['pumpTroubleshooting','Pump'],['unloaderTroubleshooting','Unloader'],['oilBurnerTroubleshooting','Oil Burner'],['gasHeaterTroubleshooting','Gas Heater']];for(const[key,label]of ssts){const section=KB.alk.serviceSchool[key];if(!section)continue;for(const[prob,causes]of Object.entries(section)){const pn=norm(prob);if(pn.split(' ').some(w=>w.length>3&&q.includes(w))||causes.some(c=>norm(c.cause).split(' ').some(w=>w.length>4&&q.includes(w)))){html+=`<h4>${label}: ${prob}</h4>${renderCauses(causes,3)}`;found=true;}}}}
  if(KB.alk.serviceSchool&&!found){const refs={pumpService:['pump','head','plunger','packing','cavitation','oil'],electrical:['electrical','switch','vacuum switch','pressure switch','contactor','cad cell','gfi','timer','cam switch'],coils:['coil','descal','scale','heat exchanger','smoke test'],burners:['burner','fuel','nozzle gauge','electrode','solenoid','jet','combustion','venting','exhaust'],nozzles:['nozzle','spray tip','spray angle','soap nozzle','impact nozzle'],unloaders:['unloader','relief valve','pulse hose','accumulator','float tank','chemical inject']};for(const[key,kws]of Object.entries(refs)){if(kws.some(kw=>q.includes(kw))){const section=KB.alk.serviceSchool[key];if(section){html+=`<h4>${key.replace(/([A-Z])/g,' $1').trim()}</h4>`;if(typeof section==='object'&&!Array.isArray(section)){for(const[k,v]of Object.entries(section)){if(typeof v==='string'){const vn=norm(v);if(kws.some(kw=>vn.includes(kw))||q.split(' ').some(w=>w.length>3&&vn.includes(w))){html+=`<div class="info-block"><p><strong>${k.replace(/([A-Z])/g,' $1').trim()}:</strong> ${v}</p></div>`;}}}}found=true;break;}}}}
  if(/warranty|coverage|covered/.test(q)&&!found){html+=`<h4>Warranty</h4><div class="info-block"><p><strong>Pumps:</strong> ${KB.gp.warranty.pumpWarranty}</p><p><strong>Manifolds:</strong> ${KB.gp.warranty.manifoldWarranty}</p></div>`;found=true;}
  if(/system|motor|engine|pulley|spray tip|unloader|thermal|hose|plumbing/.test(q)&&!found){html+=`<h4>System Design</h4>`;for(const item of Object.values(KB.gp.systemDesign)){const tw=norm(item.title).split(' ');if(tw.some(w=>w.length>3&&q.includes(w)))html+=`<div class="info-block"><p><strong>${item.title}:</strong> ${item.text}</p></div>`;}found=true;}
  if(!found){const ar=[];for(const[cat,items]of Object.entries(KB.gp.accessories))for(const item of items)if(norm(item[0]).includes(q)||norm(item[1]).includes(q))ar.push({cat,part:item[0],desc:item[1]});if(ar.length>0){html+=`<h4>Accessories</h4><table class="data-table"><thead><tr><th>Part</th><th>Category</th><th>Description</th></tr></thead><tbody>`;for(const r of ar.slice(0,20))html+=`<tr><td class="model-cell">${r.part}</td><td>${r.cat}</td><td style="font-family:var(--font-body);color:var(--text-muted)">${r.desc}</td></tr>`;html+=`</tbody></table>`;found=true;}}
  if(!found)html+=`<div class="info-block"><p>I can help with:</p><p>ğŸ” Pump lookup â€” model or specs</p><p>ğŸ”§ Troubleshooting â€” pressure, leaks, noise, packing</p><p>ğŸ›¢ï¸ Oil â€” "oil for TS2021"</p><p>ğŸ”¥ Troubleshooting â€” burner, pilot, motor, temperature</p><p>ğŸ—“ï¸ Maintenance â€” schedules for both brands</p></div>`;
  return html;}

/* â•â•â• CHAT STATE â•â•â• */
let chatMessages=[];
let chatHistory=[]; // plain text history sent to API for conversation context
let chatMsgId=0;
let inChat=false;

function ensureChatView(){
  if(!inChat){
    inChat=true;
    document.querySelector('.input-bar').classList.remove('hidden');
    history.pushState({view:'chat'},'','#chat');
    C.innerHTML=`<div class="section-page"><div class="chat-nav"><button class="nav-btn" onclick="exitChat()">ğŸ  Home</button><button class="nav-btn primary" onclick="newChat()">ï¼‹ New Chat</button><button class="nav-btn" onclick="openSaveDialog()" style="margin-left:auto">ğŸ’¾ Save</button></div><div class="messages" id="chatMessages"></div></div>`;
  }
}

function exitChat(){inChat=false;chatMessages=[];chatHistory=[];chatMsgId=0;I.placeholder='Search models, troubleshoot issues, look up specs\u2026';document.querySelector('.input-bar').classList.add('hidden');showHome();}
function newChat(){chatMessages=[];chatHistory=[];chatMsgId=0;inChat=false;I.placeholder='Search models, troubleshoot issues, look up specs\u2026';ensureChatView();
  const el=document.getElementById('chatMessages');if(el)el.innerHTML='';
  inChat=true;
}

function addChatMsg(role, html){
  chatMessages.push({role,html});
  const el=document.getElementById('chatMessages');
  if(!el)return;
  if(role==='user'){
    el.innerHTML+=`<div class="msg msg-user"><div class="bubble">${html}</div></div>`;
  } else {
    chatMsgId++;
    el.innerHTML+=`<div class="msg msg-bot"><div class="bot-avatar" style="background:var(--accent);color:#fff;font-size:0.6rem;font-weight:700">AI</div><div class="bubble" id="aiText${chatMsgId}">${html}</div></div>`;
  }
  scrollBottom();
}

let _aiTruncId=0;
function formatAIText(raw){
  const MAX=600;
  let formatted=raw
    .replace(/\n\n/g,'</p><p>')
    .replace(/\n/g,'<br>')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/^/, '<p>') + '</p>';
  if(raw.length>MAX){
    _aiTruncId++;
    const cutPoint=raw.lastIndexOf(' ',MAX);
    const shortRaw=raw.substring(0,cutPoint>200?cutPoint:MAX);
    const shortHtml=shortRaw
      .replace(/\n\n/g,'</p><p>')
      .replace(/\n/g,'<br>')
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
      .replace(/^/, '<p>') + 'â€¦</p>';
    return shortHtml+`<button class="show-more-btn" onclick="this.style.display='none';document.getElementById('aiTr${_aiTruncId}').style.display='block';document.getElementById('aiSh${_aiTruncId}').style.display='none'" style="background:none;border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.8rem;cursor:pointer;font-size:0.78rem;color:var(--accent);font-family:var(--font-body);margin-top:0.5rem" id="aiSh${_aiTruncId}">Show full response â–¾</button><div id="aiTr${_aiTruncId}" style="display:none">${formatted}</div>`;
  }
  return formatted;
}

function showSearch(query,img){setActive('home');
  ensureChatView();
  const imgHtml=img?`<img src="data:${img.mediaType};base64,${img.data}" class="img-in-chat" alt="Uploaded photo"/><br>`:'';
  addChatMsg('user', imgHtml+esc(query));
  addChatMsg('bot', `<span class="ai-loading">ğŸ” Searchingâ€¦</span>`);
  const myId=chatMsgId;
  
  // Build request with conversation history
  const body={message:query, history:chatHistory};
  if(img){body.image=img.data;body.image_type=img.mediaType;}
  
  // Track user message in history for next request
  chatHistory.push({role:'user', content:query});
  
  fetch('/api/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  }).then(r=>r.json()).then(data=>{
    const el=document.getElementById('aiText'+myId);
    if(!el)return;
    if(data.reply){
      el.innerHTML=formatAIText(data.reply);
      // Track assistant reply in history for next request
      chatHistory.push({role:'assistant', content:data.reply});
      I.placeholder='Type your reply or ask a follow-up question...';
      I.focus();
      // Add save button after AI bubble
      injectSaveButton(el);
      var userMsgs=document.querySelectorAll('.msg-user');
      var lastUser=userMsgs[userMsgs.length-1];
      if(lastUser)scrollToMsg(lastUser);
    } else if(data.error){
      el.innerHTML='<span style="color:var(--text-muted)">AI unavailable: '+esc(data.error)+'</span>';
    }
    scrollBottom();
  }).catch(e=>{
    const el=document.getElementById('aiText'+myId);
    if(el) el.innerHTML=img?'<span style="color:var(--text-muted)">Image analysis requires AI agent.</span>':genResponse(query);
  });
}

/* â•â•â• CONVERSATIONAL FLOW â•â•â• */
function startTopic(topic){
  const topicLabels={pressure:'Low Pressure',oil:'Oil Lookup',burner:'Burner Issues',service:'Service & Repair',chemical:'Chemical Issues',find:'Find a Pump',pilot:'Pilot Light',maintenance:'Maintenance',leak:'Leaks',noise:'Noise',packing:'Packing Failure',overheating:'Overheating',rough:'Rough Running',pulsation:'Pulsation',valves:'Valve Service',plungers:'Plunger Replacement',vpackings:'V-Packing Replacement',catalog:'Product Catalog',accessories:'Accessories',system:'System Design',warranty:'Warranty',electrical:'Electrical',coils:'Coils & Heat Exchangers',nozzles:'Spray Nozzles',unloaders:'Unloaders',checklist:'Pre-Service Checklist',installation:'Installation',startup:'Start-Up Procedure',nozzle:'Nozzle Calculator',injector:'Injector Sizing',multimeter:'Multimeter Assistant'};
  const label=topicLabels[topic]||topic;
  setActive('home');
  ensureChatView();

  const topicOptions={
    pressure:[
      ['ğŸ“‰','Pressure drops during use','My pressure drops while I am spraying'],
      ['â›”','No pressure at all','My pump is running but I have no pressure output'],
      ['ğŸ“Š','Pressure is lower than rated','My pump pressure is lower than what it should be rated for'],
      ['ğŸ’§','Pressure fluctuates up and down','My pressure is surging or fluctuating up and down']
    ],
    oil:[
      ['ğŸ›¢ï¸','Need oil recommendation','What oil does my pump need? I need the model-specific recommendation'],
      ['ğŸ”„','When to change oil','How often should I change my pump oil and what is the procedure?'],
      ['ğŸ¥›','Oil looks milky or contaminated','My pump oil looks milky or has water in it']
    ],
    burner:[
      ['ğŸ”¥','Won\'t fire','Burner will not fire at all'],
      ['ğŸ’¨','Pilot won\'t stay lit','Pilot will not stay lit'],
      ['âš ï¸','Fires then shuts off','Burner fires but shuts off after a short time'],
      ['ğŸŒ«ï¸','Smoke / soot','There is smoke or soot coming from the burner']
    ],
    service:[
      ['ğŸ”§','Pump rebuild','I need to rebuild or service my pump'],
      ['âš™ï¸','Replace seals or packings','I need to replace seals or v-packings on my pump'],
      ['ğŸ”©','Replace valves','I need to replace or service the check valves'],
      ['ğŸ“‹','General service steps','What are the general service procedures for my equipment?']
    ],
    chemical:[
      ['ğŸ§ª','Won\'t draw chemical','My machine will not draw chemical or detergent'],
      ['ğŸ’§','Chemical is too weak','Chemical is being applied but it is too diluted or weak'],
      ['ğŸš«','Chemical injector leaking','My chemical injector is leaking or dripping'],
      ['â“','Injector setup help','How do I set up or adjust my chemical injection system?']
    ],
    find:[
      ['ğŸ“Š','By GPM and PSI','I need a pump with specific GPM and PSI ratings'],
      ['ğŸ—ï¸','By application','I need a pump recommendation for a specific application'],
      ['ğŸ”„','Replacement pump','I need to find a replacement pump for my current one'],
      ['ğŸ“‹','Compare models','I want to compare pump models and specifications']
    ],
    pilot:[
      ['ğŸ”¥','Won\'t ignite','Pilot will not ignite at all'],
      ['ğŸ’¨','Won\'t stay lit','Pilot lights but will not stay lit'],
      ['âš¡','Ignitor not sparking','The ignitor is not producing a spark'],
      ['ğŸŒ¬ï¸','Blows out easily','Pilot blows out in wind or during operation']
    ],
    maintenance:[
      ['ğŸ—“ï¸','Maintenance schedule','What is the recommended maintenance schedule for my equipment?'],
      ['â„ï¸','Winterizing','How do I winterize or store my pressure washer for the season?'],
      ['â–¶ï¸','Start-up procedure','What is the proper start-up procedure?'],
      ['ğŸ›‘','Shutdown procedure','What is the proper shutdown procedure?']
    ],
    nozzle:[
      ['ğŸ¯','Size a nozzle','I need to find the right nozzle size for my setup'],
      ['ğŸ“Š','Check my nozzle','I have a nozzle and want to know what GPM it delivers at my PSI'],
      ['ğŸ”„','Nozzle is worn','My nozzle seems worn â€” I am losing pressure']
    ],
    injector:[
      ['ğŸ’‰','Size an injector','I need to size a chemical injector for my system'],
      ['ğŸ“','Calculate draw rate','I want to know how much chemical my injector will use per hour'],
      ['ğŸ”§','Injector not drawing','My chemical injector is not drawing soap']
    ],
    multimeter:[
      ['âš¡','Machine is dead','My machine has no power at all â€” walk me through testing it'],
      ['ğŸ”Œ','Motor hums but won\'t spin','Motor hums but won\'t turn â€” could be capacitor'],
      ['ğŸ”¥','Burner shuts off (CAD cell)','Burner fires then locks out â€” need to test the flame sensor'],
      ['âš ï¸','Keeps tripping GFCI','Machine trips the GFCI every time I plug it in']
    ],
    electrical:[
      ['âš¡','Machine won\'t start','My machine is completely dead and won\'t start at all'],
      ['ğŸ”Œ','Trips breaker','My machine trips the breaker or GFCI when I turn it on'],
      ['ã€°ï¸','Intermittent power','Machine starts and stops, or works sometimes but not others'],
      ['ğŸ”Š','Motor hums but won\'t spin','Motor makes a humming noise but the shaft won\'t turn']
    ]
  };

  const options=topicOptions[topic];
  if(options){
    let btns=options.map(([icon,label,q])=>
      `<button class="quick-btn" onclick="askQ('${q.replace(/'/g,"\\'")}')"><span class="qicon">${icon}</span> ${label}</button>`
    ).join('');
    addChatMsg('bot',`<p>I can help with <strong>${esc(topicLabels[topic])}</strong>. What's going on?</p>
      <div class="quick-actions" style="margin-top:0.75rem">${btns}</div>
      <p style="margin-top:0.5rem;font-size:0.82rem;color:var(--text-muted)">Or type your own description below.</p>`);
    I.focus();I.placeholder='Describe your issue or ask a question...';
    scrollBottom();
    return;
  }

  // Fallback for sidebar topics without custom options â€” send straight to AI
  showSearch('I need help with '+label+'. What should I know?');
}

function pickBrand(brand, topic){
  const topicLabels={pressure:'low pressure',oil:'oil recommendation',burner:'burner issues',service:'service and repair',chemical:'chemical injection issues',find:'finding a pump',pilot:'pilot light issues',maintenance:'maintenance schedule',leak:'leaks',noise:'noise issues',packing:'packing failure',overheating:'overheating',rough:'rough running',pulsation:'pulsation',valves:'valve service',plungers:'plunger replacement',vpackings:'v-packing replacement',catalog:'product catalog',accessories:'accessories',system:'system design',warranty:'warranty',electrical:'electrical components',coils:'coils and heat exchangers',nozzles:'spray nozzles',unloaders:'unloaders',checklist:'pre-service checklist',installation:'installation',startup:'start-up procedure'};
  const label=topicLabels[topic]||topic;
  addChatMsg('user', esc(brand));
  // Topics that need a model number
  const needsModel=['oil','find','service','valves','plungers','vpackings'];
  if(needsModel.includes(topic)){
    const modelPrompt=topic==='find'?'What specifications are you looking for? Enter GPM, PSI, or application details.':'What\'s the model number?';
    addChatMsg('bot', `<p>${modelPrompt}</p>`);
    I.focus();I.placeholder=topic==='find'?'e.g. 4 GPM, 3000 PSI, belt drive...':'e.g. TS2021, EZ4040G, KFMZ...';
    window._pendingContext=brand+' '+label+(topic==='find'?' matching ':' for model ');
    return;
  }
  // Default: send directly to AI with brand context
  const prompt=brand==='Not sure'
    ? `I need help with ${label}. I'm not sure which brand. Can you help me figure it out?`
    : `I have a ${brand} unit and need help with ${label}. What should I check?`;
  showSearch(prompt);
}

/* â•â•â• ROUTING â•â•â• */
function nav(t){
  if(t==='home')return showHome();
  // Strip prefix and route through conversational flow
  if(t.startsWith('gp-')){const topic=t.slice(3);startTopic(topic);return;}
  if(t.startsWith('alk-ts-')){const topic=t.slice(7);startTopic(topic);return;}
  if(t.startsWith('alk-')){const topic=t.slice(4);startTopic(topic);return;}
  startTopic(t);
}

function homeSearch(){const hi=document.getElementById('homeInput');if(!hi)return;const q=hi.value.trim();if(!q&&!pendingImage)return;hi.value='';const img=pendingImage;clearImage();showSearch(q||'Identify this equipment and any visible issues.',img);}

function handleSend(){const q=I.value.trim();if(!q&&!pendingImage)return;I.value='';I.placeholder='Search models, troubleshoot issues, look up specs...';
  const img=pendingImage;clearImage();
  if(window._pendingContext){const full=window._pendingContext+(q||'');window._pendingContext=null;showSearch(full,img);return;}
  // If input is numbers only, ask for full model number
  if(!img && /^\d+$/.test(q)){
    ensureChatView();
    addChatMsg('user', esc(q));
    addChatMsg('bot', `<p>It looks like you entered just a number. Could you provide the <strong>full model number</strong> including letters? For example: <strong>TS2021</strong>, <strong>EZ4040G</strong>, <strong>KFMZ</strong>, etc.</p>`);
    I.focus();I.placeholder='e.g. TS2021, EZ4040G, T1011...';
    window._pendingContext='Look up pump model ';
    return;
  }
  showSearch(q||'Identify this equipment and any visible issues.',img);
}
function askQ(q){I.value=q;handleSend();}
I.addEventListener('keydown',e=>{if(e.key==='Enter')handleSend()});

if(typeof KB!=='undefined'&&KB.meta){document.getElementById('headerStats').innerHTML=`<div class="stat"><div class="stat-val">${KB.meta.stats.gpPumps}</div><div class="stat-label">Pumps</div></div><div class="stat"><div class="stat-val">${KB.meta.stats.totalSources}</div><div class="stat-label">Sources</div></div>`;}
buildSidebar();showHome();I.focus();
document.addEventListener('click',function(e){const m=document.getElementById('hamMenu');if(m&&!e.target.closest('.hamburger')&&!e.target.closest('.ham-menu'))m.classList.remove('open');});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVED DIAGNOSTICS â€” Save, Browse, View, Download, Delete
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function openSaveDialog(){
  // Gather conversation from chat
  const convo = chatHistory.map(m => ({role:m.role, content:m.content}));
  const lastAI = [...chatHistory].reverse().find(m=>m.role==='assistant');
  
  document.getElementById('saveModal').classList.add('open');
  document.getElementById('saveTitleInput').value = '';
  document.getElementById('saveMachineInput').value = '';
  document.getElementById('saveBrandInput').value = '';
  document.getElementById('saveModelInput').value = '';
  document.getElementById('saveSerialInput').value = '';
  document.getElementById('saveCategoryInput').value = '';
  document.getElementById('saveSeverityInput').value = 'medium';
  document.getElementById('saveDiagInput').value = '';
  document.getElementById('saveStepsInput').value = '';
  document.getElementById('savePartsInput').value = '';
  document.getElementById('saveNotesInput').value = '';
  document.getElementById('saveConvoData').value = JSON.stringify(convo);
  
  // Auto-fill title from first user message
  const firstMsg = chatHistory.find(m=>m.role==='user');
  if(firstMsg) document.getElementById('saveTitleInput').value = firstMsg.content.substring(0, 80);
  
  document.getElementById('saveTitleInput').focus();
}

function closeSaveDialog(){
  document.getElementById('saveModal').classList.remove('open');
}

async function confirmSave(){
  const data = {
    title: document.getElementById('saveTitleInput').value || 'Untitled',
    machine_name: document.getElementById('saveMachineInput').value || null,
    machine_brand: document.getElementById('saveBrandInput').value || null,
    machine_model: document.getElementById('saveModelInput').value || null,
    machine_serial: document.getElementById('saveSerialInput').value || null,
    category: document.getElementById('saveCategoryInput').value || null,
    severity: document.getElementById('saveSeverityInput').value || null,
    diagnosis: document.getElementById('saveDiagInput').value || null,
    steps: document.getElementById('saveStepsInput').value ? document.getElementById('saveStepsInput').value.split('\n').filter(s=>s.trim()) : null,
    parts_used: document.getElementById('savePartsInput').value ? document.getElementById('savePartsInput').value.split('\n').filter(s=>s.trim()) : null,
    notes: document.getElementById('saveNotesInput').value || null,
    conversation: JSON.parse(document.getElementById('saveConvoData').value || '[]')
  };

  try {
    const r = await fetch('/api/saved-diags', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    const result = await r.json();
    if(result.id){
      closeSaveDialog();
      // Mark save button as saved
      const btn = document.querySelector('.save-btn:not(.saved)');
      if(btn){btn.classList.add('saved');btn.innerHTML='âœ… Saved';}
      // Brief toast
      showToast('Diagnostic saved â€” #' + result.id);
    } else {
      alert('Save failed: '+(result.error||'Unknown error'));
    }
  } catch(e){
    alert('Save failed: '+e.message);
  }
}

function showToast(msg){
  const t=document.createElement('div');
  t.style.cssText='position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#16a34a;color:#fff;padding:10px 20px;border-radius:10px;font-size:0.85rem;font-family:var(--font-body);z-index:10000;animation:fadeUp 0.3s';
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 2500);
}

async function showSavedDiags(){
  setActive('saved-diags');
  inChat=false;
  document.querySelector('.input-bar').classList.add('hidden');
  C.innerHTML='<div class="section-page"><button class="back-btn" onclick="showHome()">â† Back</button><div class="page-header"><div class="page-header-icon">ğŸ“‹</div><div><h2>Saved Diagnostics</h2><p>Your diagnostic history</p></div></div><div id="diagListContainer"><div style="text-align:center;padding:2rem;color:var(--text-muted)">Loading...</div></div></div>';
  
  try {
    const r = await fetch('/api/saved-diags');
    const diags = await r.json();
    const container = document.getElementById('diagListContainer');
    
    if(!diags.length){
      container.innerHTML='<div class="diag-empty"><div class="diag-empty-icon">ğŸ“‹</div><p>No saved diagnostics yet</p><p style="font-size:0.82rem;margin-top:0.5rem">After diagnosing a problem in chat, click <strong>ğŸ’¾ Save Diagnosis</strong> to keep a record.</p></div>';
      return;
    }
    
    let html='<div class="diag-list">';
    for(const d of diags){
      const date = new Date(d.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
      html+=`<div class="diag-card" onclick="viewSavedDiag(${d.id})">
        <div class="diag-card-header">
          <div>
            <h4>${esc(d.title)}</h4>
            <div class="diag-meta">${date}${d.category?' Â· <span class="diag-category">'+esc(d.category)+'</span>':''}${d.severity?' Â· <span class="sev-badge sev-'+d.severity+'">'+d.severity.toUpperCase()+'</span>':''}</div>
            ${d.machine_name||d.machine_model?'<div class="diag-machine">ğŸ”§ '+(d.machine_name?esc(d.machine_name):'')+(d.machine_model?' Â· '+esc(d.machine_model):'')+'</div>':''}
          </div>
          <div class="diag-card-actions" onclick="event.stopPropagation()">
            <button class="dl-btn" onclick="downloadDiag(${d.id})" title="Download report">ğŸ“„</button>
            <button class="del-btn" onclick="deleteDiag(${d.id},'${esc(d.title).replace(/'/g,"\\'")}')" title="Delete">ğŸ—‘</button>
          </div>
        </div>
      </div>`;
    }
    html+='</div>';
    container.innerHTML=html;
  } catch(e){
    document.getElementById('diagListContainer').innerHTML='<div style="color:var(--text-muted);text-align:center;padding:2rem">Failed to load: '+e.message+'</div>';
  }
}

async function viewSavedDiag(id){
  C.innerHTML='<div class="section-page"><button class="back-btn" onclick="showSavedDiags()">â† Back to List</button><div style="text-align:center;padding:2rem;color:var(--text-muted)">Loading...</div></div>';
  
  try {
    const r = await fetch('/api/saved-diags/'+id);
    const d = await r.json();
    const date = new Date(d.created_at).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'});
    
    let html='<div class="section-page"><button class="back-btn" onclick="showSavedDiags()">â† Back to List</button>';
    html+='<div class="diag-detail-header"><div><h2 style="font-size:1.3rem;margin-bottom:0.25rem">'+esc(d.title)+'</h2>';
    html+='<div style="font-size:0.78rem;color:var(--text-muted)">'+date+'</div></div>';
    html+='<div class="diag-detail-actions"><button class="nav-btn" onclick="downloadDiag('+d.id+')">ğŸ“„ Download Report</button>';
    html+='<button class="nav-btn" style="color:#ef4444;border-color:#ef4444" onclick="deleteDiag('+d.id+',\''+esc(d.title).replace(/'/g,"\\'")+'\')">ğŸ—‘ Delete</button></div></div>';
    
    // Machine info
    if(d.machine_name||d.machine_brand||d.machine_model||d.machine_serial){
      html+='<div class="card" style="margin-bottom:1rem"><h4>Machine Info</h4><div class="meta-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-top:0.5rem;font-size:0.85rem">';
      if(d.machine_name) html+='<div><span style="color:var(--text-muted);font-size:0.72rem">NAME</span><br>'+esc(d.machine_name)+'</div>';
      if(d.machine_brand) html+='<div><span style="color:var(--text-muted);font-size:0.72rem">BRAND</span><br>'+esc(d.machine_brand)+'</div>';
      if(d.machine_model) html+='<div><span style="color:var(--text-muted);font-size:0.72rem">MODEL</span><br>'+esc(d.machine_model)+'</div>';
      if(d.machine_serial) html+='<div><span style="color:var(--text-muted);font-size:0.72rem">SERIAL</span><br>'+esc(d.machine_serial)+'</div>';
      html+='</div></div>';
    }
    
    // Category + severity
    if(d.category||d.severity){
      html+='<div style="display:flex;gap:0.75rem;margin-bottom:1rem;flex-wrap:wrap">';
      if(d.category) html+='<span class="diag-category" style="font-size:0.8rem;padding:0.25rem 0.75rem">'+esc(d.category)+'</span>';
      if(d.severity) html+='<span class="sev-badge sev-'+d.severity+'" style="font-size:0.75rem;padding:3px 12px">'+d.severity.toUpperCase()+'</span>';
      html+='</div>';
    }
    
    // Diagnosis
    if(d.diagnosis){
      html+='<div class="card" style="margin-bottom:1rem;background:var(--accent-dim);border-color:var(--accent)"><h4>Diagnosis</h4><p style="margin-top:0.4rem;font-size:0.88rem;line-height:1.6">'+esc(d.diagnosis)+'</p></div>';
    }
    
    // Steps
    if(Array.isArray(d.steps)&&d.steps.length){
      html+='<div class="card" style="margin-bottom:1rem"><h4>Diagnostic Steps</h4><div style="margin-top:0.5rem">';
      d.steps.forEach((s,i)=>{
        html+='<div style="display:flex;gap:0.75rem;padding:0.5rem 0;border-bottom:1px solid var(--border);font-size:0.85rem"><span style="color:var(--accent);font-weight:700;min-width:1.5rem">'+(i+1)+'</span><span>'+esc(s)+'</span></div>';
      });
      html+='</div></div>';
    }
    
    // Parts
    if(Array.isArray(d.parts_used)&&d.parts_used.length){
      html+='<div class="card" style="margin-bottom:1rem"><h4>Parts Used / Needed</h4><div style="margin-top:0.5rem;display:flex;flex-wrap:wrap;gap:0.4rem">';
      d.parts_used.forEach(p=>{html+='<span class="tag" style="font-size:0.78rem;padding:0.2rem 0.6rem">'+esc(p)+'</span>';});
      html+='</div></div>';
    }
    
    // Notes
    if(d.notes){
      html+='<div class="card" style="margin-bottom:1rem;background:rgba(245,158,11,0.04);border-color:rgba(245,158,11,0.2)"><h4>ğŸ“ Notes</h4><p style="margin-top:0.4rem;font-size:0.85rem;line-height:1.6;white-space:pre-wrap">'+esc(d.notes)+'</p></div>';
    }
    
    // Conversation
    if(Array.isArray(d.conversation)&&d.conversation.length){
      html+='<div class="card" style="margin-bottom:1rem"><h4>Full Conversation</h4><div style="margin-top:0.5rem">';
      d.conversation.forEach(m=>{
        const isUser=m.role==='user';
        html+='<div style="padding:0.6rem 0.75rem;border-bottom:1px solid var(--border);background:'+(isUser?'var(--accent-dim)':'transparent')+'">';
        html+='<div style="font-size:0.68rem;font-weight:700;color:'+(isUser?'var(--accent)':'#16a34a')+';text-transform:uppercase;margin-bottom:0.2rem">'+(isUser?'You':'P-Supp AI')+'</div>';
        html+='<div style="font-size:0.83rem;line-height:1.55;white-space:pre-wrap">'+esc(m.content||'')+'</div></div>';
      });
      html+='</div></div>';
    }
    
    html+='</div>';
    C.innerHTML=html;
    MAIN.scrollTop=0;
  } catch(e){
    C.innerHTML='<div class="section-page"><button class="back-btn" onclick="showSavedDiags()">â† Back</button><p style="color:var(--text-muted)">Error loading diagnostic: '+e.message+'</p></div>';
  }
}

function downloadDiag(id){
  window.open('/api/saved-diags/'+id+'/report','_blank');
}

async function deleteDiag(id, title){
  if(!confirm('Delete "'+title+'"? This cannot be undone.')) return;
  try {
    await fetch('/api/saved-diags/'+id, {method:'DELETE'});
    showToast('Diagnostic deleted');
    showSavedDiags();
  } catch(e){
    alert('Delete failed: '+e.message);
  }
}

// Inject save button after AI responds in chat
function injectSaveButton(afterEl){
  if(!afterEl) return;
  // Find the parent .msg div and add save button after it
  const msgDiv = afterEl.closest('.msg');
  if(!msgDiv) return;
  const existing = msgDiv.parentElement.querySelector('.save-btn');
  if(existing) return;
  const btn = document.createElement('button');
  btn.className = 'save-btn';
  btn.innerHTML = 'ğŸ’¾ Save Diagnosis';
  btn.onclick = openSaveDialog;
  msgDiv.after(btn);
}
</script>

<!-- Save Diagnostic Modal -->
<div class="save-modal-overlay" id="saveModal">
  <div class="save-modal">
    <h3>ğŸ’¾ Save Diagnostic Report</h3>
    <div class="save-field">
      <label>Title *</label>
      <input type="text" id="saveTitleInput" placeholder="e.g., Low pressure on Unit #3"/>
    </div>
    <div class="save-row">
      <div class="save-field"><label>Machine Name</label><input type="text" id="saveMachineInput" placeholder="e.g., Bay 2 Hot Water"/></div>
      <div class="save-field"><label>Brand</label><input type="text" id="saveBrandInput" placeholder="e.g., General Pump"/></div>
    </div>
    <div class="save-row">
      <div class="save-field"><label>Model</label><input type="text" id="saveModelInput" placeholder="e.g., TS2021"/></div>
      <div class="save-field"><label>Serial #</label><input type="text" id="saveSerialInput" placeholder="e.g., GP-2024-0847"/></div>
    </div>
    <div class="save-row">
      <div class="save-field"><label>Category</label>
        <select id="saveCategoryInput">
          <option value="">Select...</option>
          <option value="Flow / Pressure">Flow / Pressure</option>
          <option value="Heat / Burner">Heat / Burner</option>
          <option value="Electrical">Electrical</option>
          <option value="Leak">Leak</option>
          <option value="Noise / Vibration">Noise / Vibration</option>
          <option value="Engine">Engine</option>
          <option value="Packing / Seals">Packing / Seals</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="save-field"><label>Severity</label>
        <select id="saveSeverityInput">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
          <option value="critical">Critical</option>
        </select>
      </div>
    </div>
    <div class="save-field"><label>Diagnosis / Conclusion</label><textarea id="saveDiagInput" placeholder="What was the root cause?"></textarea></div>
    <div class="save-field"><label>Steps Taken (one per line)</label><textarea id="saveStepsInput" rows="4" placeholder="Checked inlet pressure&#10;Replaced HP packing kit&#10;Tested at full PSI â€” holding steady"></textarea></div>
    <div class="save-field"><label>Parts Used / Needed (one per line)</label><textarea id="savePartsInput" rows="3" placeholder="HP Packing Kit #69591&#10;Plunger #22mm&#10;O-ring set"></textarea></div>
    <div class="save-field"><label>Notes</label><textarea id="saveNotesInput" placeholder="Additional observations, follow-up needed, etc."></textarea></div>
    <input type="hidden" id="saveConvoData" value="[]"/>
    <div class="save-actions">
      <button class="cancel-btn" onclick="closeSaveDialog()">Cancel</button>
      <button class="confirm-btn" onclick="confirmSave()">ğŸ’¾ Save Diagnostic</button>
    </div>
  </div>
</div>
</div><!-- end appContent -->
<style>
.pwa-install-bar{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:0.75rem 1.5rem;display:flex;align-items:center;justify-content:space-between;z-index:200;box-shadow:0 -4px 12px rgba(0,0,0,0.06);transform:translateY(100%);transition:transform 0.3s}
.pwa-install-bar.show{transform:translateY(0)}
.pwa-install-bar .install-text{font-size:0.85rem;color:var(--text)}
.pwa-install-bar .install-text small{color:var(--text-muted);display:block;font-size:0.72rem}
.pwa-install-btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 18px;font-size:0.82rem;font-family:var(--font-body);font-weight:600;cursor:pointer}
.pwa-install-btn:hover{opacity:0.9}
.pwa-dismiss{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;padding:4px 8px}
</style>
<div class="pwa-install-bar" id="pwaBar">
  <div class="install-text">Install P-Supp<small>Add to home screen for quick access</small></div>
  <div style="display:flex;gap:0.5rem;align-items:center">
    <button class="pwa-install-btn" id="pwaInstallBtn">Install</button>
    <button class="pwa-dismiss" onclick="document.getElementById('pwaBar').classList.remove('show');sessionStorage.setItem('pwaDismissed','1')">âœ•</button>
  </div>
</div>
<script>
// Register service worker
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(r=>console.log('[PWA] SW registered')).catch(e=>console.log('[PWA] SW error:',e));
}
// Install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  if(!sessionStorage.getItem('pwaDismissed')){
    document.getElementById('pwaBar').classList.add('show');
  }
});
document.getElementById('pwaInstallBtn').addEventListener('click', async () => {
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  console.log('[PWA] Install:', result.outcome);
  deferredPrompt = null;
  document.getElementById('pwaBar').classList.remove('show');
});
window.addEventListener('appinstalled', () => {
  document.getElementById('pwaBar').classList.remove('show');
  console.log('[PWA] Installed');
});
</script>
</body>
</html>
