<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign In — P-Supp</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0c0f14;
  --surface: #141820;
  --surface-2: #1a1f2b;
  --border: #2a3144;
  --text: #e4e8f1;
  --text-muted: #8892a8;
  --accent: #f59e0b;
  --accent-dim: rgba(245,158,11,0.12);
  --blue: #3b82f6;
  --green: #22c55e;
  --danger: #ef4444;
  --radius: 12px;
  --font-body: 'DM Sans', sans-serif;
  --font-mono: 'Space Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

body::before {
  content: '';
  position: fixed;
  top: -200px; left: -200px;
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(245,158,11,0.06) 0%, transparent 70%);
  pointer-events: none;
}

.login-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 2.5rem 2rem;
  width: 100%;
  max-width: 380px;
  position: relative;
}

.logo {
  text-align: center;
  margin-bottom: 2rem;
}
.logo .mark {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 48px; height: 48px;
  background: var(--accent);
  border-radius: 12px;
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--bg);
  margin-bottom: 0.75rem;
}
.logo h1 {
  font-size: 1.25rem;
  font-weight: 600;
  letter-spacing: -0.02em;
}
.logo p {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 0.3rem;
}

.field {
  margin-bottom: 1.25rem;
}
.field label {
  display: block;
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.4rem;
}
.field input {
  width: 100%;
  padding: 0.7rem 0.9rem;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: var(--font-body);
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.2s;
}
.field input:focus {
  border-color: var(--accent);
}
.field input::placeholder {
  color: #555b6e;
}

.btn-login {
  width: 100%;
  padding: 0.75rem;
  background: var(--accent);
  color: var(--bg);
  border: none;
  border-radius: 8px;
  font-family: var(--font-body);
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 0.5rem;
}
.btn-login:hover { filter: brightness(1.1); transform: translateY(-1px); }
.btn-login:active { transform: translateY(0); }
.btn-login:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.error-msg {
  background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.25);
  color: var(--danger);
  font-size: 0.8rem;
  padding: 0.6rem 0.9rem;
  border-radius: 8px;
  margin-bottom: 1rem;
  display: none;
  animation: shake 0.4s ease;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  75% { transform: translateX(6px); }
}

.role-indicator {
  text-align: center;
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
  font-size: 0.72rem;
  color: var(--text-muted);
  display: none;
}
.role-indicator .role-badge {
  display: inline-block;
  padding: 0.15rem 0.5rem;
  border-radius: 6px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  margin-left: 0.3rem;
}
.role-admin  { background: rgba(245,158,11,0.15); color: var(--accent); }
.role-techp  { background: rgba(34,197,94,0.15); color: var(--green); }
.role-tech   { background: rgba(59,130,246,0.15); color: var(--blue); }

.security-note {
  text-align: center;
  margin-top: 1.5rem;
  font-size: 0.68rem;
  color: #555b6e;
}
.security-note svg { vertical-align: -2px; margin-right: 3px; }
</style>
</head>
<body>

<div class="login-card">
  <div class="logo">
    <div class="mark">P</div>
    <h1>P-Supp Service Assistant</h1>
    <p>Pressure washer diagnostics &amp; support</p>
  </div>

  <div class="error-msg" id="errorMsg"></div>

  <div class="field">
    <label>Username</label>
    <input type="text" id="username" placeholder="Enter username" autocomplete="username" autofocus>
  </div>
  <div class="field">
    <label>Password</label>
    <input type="password" id="password" placeholder="Enter password" autocomplete="current-password">
  </div>

  <button class="btn-login" id="loginBtn" onclick="doLogin()">Sign In</button>

  <div class="role-indicator" id="roleIndicator">
    Signed in as <span class="role-badge" id="roleBadge"></span>
  </div>

  <div class="security-note">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
    Secure session · All activity is logged
  </div>
</div>

<script>
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const errorMsg = document.getElementById('errorMsg');
const roleIndicator = document.getElementById('roleIndicator');
const roleBadge = document.getElementById('roleBadge');

// Enter key submits
[usernameInput, passwordInput].forEach(el => {
  el.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
});

async function doLogin() {
  const username = usernameInput.value.trim();
  const password = passwordInput.value;

  if (!username || !password) {
    showError('Please enter username and password');
    return;
  }

  loginBtn.disabled = true;
  loginBtn.textContent = 'Signing in...';
  errorMsg.style.display = 'none';

  try {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    const data = await res.json();

    if (!res.ok) {
      showError(data.error || 'Login failed');
      loginBtn.disabled = false;
      loginBtn.textContent = 'Sign In';
      return;
    }

    // Show role briefly before redirect
    const roleNames = { admin: 'Administrator', techp: 'Power Technician', tech: 'Technician' };
    roleBadge.textContent = roleNames[data.user.role] || data.user.role;
    roleBadge.className = 'role-badge role-' + data.user.role;
    roleIndicator.style.display = 'block';
    loginBtn.textContent = 'Redirecting...';

    // Show query limit for tech and techp users
    if (data.queryUsage && data.queryUsage.remaining !== null) {
      roleIndicator.innerHTML += `<br>${data.queryUsage.remaining} queries remaining today`;
    }

    setTimeout(() => { window.location.href = '/'; }, 800);

  } catch (err) {
    showError('Connection error. Please try again.');
    loginBtn.disabled = false;
    loginBtn.textContent = 'Sign In';
  }
}

function showError(msg) {
  errorMsg.textContent = msg;
  errorMsg.style.display = 'block';
}
</script>
</body>
</html>
